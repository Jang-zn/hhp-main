<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¡°íšŒ ì„±ëŠ¥ ìµœì í™” ë³´ê³ ì„œ</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            securityLevel: 'loose'
        });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 { font-size: 2.2em; border-bottom: 2px solid #333; padding-bottom: 10px; }
        h2 { font-size: 1.8em; margin-top: 30px; color: #2c3e50; }
        h3 { font-size: 1.5em; margin-top: 20px; color: #34495e; }
        h4 { font-size: 1.2em; margin-top: 15px; color: #7f8c8d; }
        p { margin: 10px 0; }
        ul, ol { margin: 10px 0; padding-left: 20px; }
        li { margin: 5px 0; }
        pre { 
            background: #f5f5f5; 
            padding: 15px; 
            border-radius: 5px; 
            overflow-x: auto; 
            font-size: 0.9em;
        }
        code { 
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; 
            background: #f5f5f5; 
            padding: 2px 5px; 
            border-radius: 3px;
        }
        .mermaid {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
        }
        .severity-critical { color: #c0392b; font-weight: bold; }
        .severity-high { color: #e67e22; font-weight: bold; }
        .severity-medium { color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <h1>ì¡°íšŒ ì„±ëŠ¥ ìµœì í™” ë³´ê³ ì„œ</h1>
    </header>

    <section id="current-structure">
        <h2>1. í˜„ì¬ êµ¬ì¡° (As-Is)</h2>

        <h3>1.1 í˜„ì¬ Entity ê´€ê³„ë„</h3>
        <div class="mermaid">
            erDiagram
                user {
                    bigint id PK
                    varchar name
                    timestamp created_at
                    timestamp updated_at
                }
                
                balance {
                    bigint id PK
                    bigint user_id FK "UNIQUE"
                    decimal amount "DECIMAL(19,2)"
                    long version "ë‚™ê´€ì  ë½"
                    timestamp created_at
                    timestamp updated_at
                }
                
                product {
                    bigint id PK
                    varchar name
                    decimal price "DECIMAL(19,2)"
                    int stock
                    int reserved_stock
                    timestamp created_at
                    timestamp updated_at
                }
                
                order {
                    bigint id PK
                    bigint user_id FK
                    decimal total_amount "DECIMAL(19,2)"
                    varchar status "ENUM"
                    timestamp created_at
                    timestamp updated_at
                }
                
                order_item {
                    bigint id PK
                    bigint order_id FK
                    bigint product_id FK
                    int quantity
                    decimal price "DECIMAL(19,2)"
                    timestamp created_at
                    timestamp updated_at
                }
                
                payment {
                    bigint id PK
                    bigint order_id FK
                    bigint user_id FK
                    bigint coupon_id FK
                    varchar status "ENUM"
                    decimal amount "DECIMAL(19,2)"
                    timestamp created_at
                    timestamp updated_at
                }
                
                coupon {
                    bigint id PK
                    bigint product_id FK
                    varchar code
                    decimal discount_rate "DECIMAL(5,2)"
                    int max_issuance
                    int issued_count
                    datetime start_date
                    datetime end_date
                    varchar status "ENUM"
                    timestamp created_at
                    timestamp updated_at
                }
                
                coupon_history {
                    bigint id PK
                    bigint user_id FK
                    bigint coupon_id FK
                    bigint order_id FK
                    datetime issued_at
                    datetime used_at
                    varchar status "ENUM"
                    timestamp created_at
                    timestamp updated_at
                }
                
                popular_product_stat {
                    varchar product_id PK
                    int sales_count
                    datetime calculated_at
                }
                
                user ||--|| balance : "1:1"
                user ||--o{ order : "1:N"
                user ||--o{ payment : "1:N"
                user ||--o{ coupon_history : "1:N"
                
                product ||--o{ order_item : "1:N"
                product ||--o{ coupon : "1:N"
                product ||--|| popular_product_stat : "1:1"
                
                order ||--o{ order_item : "1:N"
                order ||--o{ payment : "1:N"
                order ||--o{ coupon_history : "used_order"
                
                coupon ||--o{ coupon_history : "1:N"
                coupon ||--o{ payment : "1:N"
        </div>

        <h3>1.2 í˜„ì¬ êµ¬ì¡°ì˜ íŠ¹ì§•</h3>
        <ul>
            <li>âœ… <code>balance</code>ì— ë‚™ê´€ì  ë½(<code>version</code>) ì ìš©</li>
            <li>âœ… <code>product</code>ì— <code>stock</code>ê³¼ <code>reserved_stock</code>ìœ¼ë¡œ ì¬ê³  ê´€ë¦¬</li>
        </ul>
        <h4>í•œê³„ì :</h4>
        <ul>
            <li>âŒ ë³µì¡í•œ ì¡°íšŒ ì‹œ ë‹¤ì¤‘ í…Œì´ë¸” JOIN í•„ìš”</li>
            <li>âŒ ì¸ë±ìŠ¤ ë¶€ì¡±ìœ¼ë¡œ ì¡°íšŒ ì„±ëŠ¥ ì €í•˜</li>
        </ul>
    </section>

    <section id="bottleneck-analysis">
        <h2>2. ì¡°íšŒ ì„±ëŠ¥ ì €í•˜ ê¸°ëŠ¥ ë° ì›ì¸ ë¶„ì„</h2>
        <h3>2.1 ì½ê¸° ì„±ëŠ¥ ë³‘ëª©</h3>
        <p class="severity-high">ğŸŸ¡ High: ë³µí•© ì¡°íšŒ ì„±ëŠ¥ ì €í•˜</p>
        <pre>
            <code class="language-sql">
SELECT o.id, o.total_amount, o.status, u.name,
       GROUP_CONCAT(p.name) as product_names,
       pay.status as payment_status, pay.amount as paid_amount
FROM order o
JOIN user u ON o.user_id = u.id
JOIN order_item oi ON o.id = oi.order_id
JOIN product p ON oi.product_id = p.id
JOIN payment pay ON o.id = pay.order_id
WHERE u.name = ? 
ORDER BY o.created_at DESC;
            </code>
        </pre>
        <h4>ë³‘ëª© ì§€ì :</h4>
        <ul>
            <li><strong>ë‹¤ì¤‘ í…Œì´ë¸” JOIN</strong>: ì—¬ëŸ¬ í…Œì´ë¸” ì¡°ì¸ìœ¼ë¡œ ì‘ë‹µ ì‹œê°„ ì¦ê°€</li>
            <li><strong>N+1 ì¿¼ë¦¬ ë¬¸ì œ</strong>: JPA Lazy Loadingìœ¼ë¡œ ì¶”ê°€ ì¿¼ë¦¬ ë°œìƒ</li>
            <li><strong>ì¸ë±ìŠ¤ ë¶€ì¡±</strong>: ë³µí•© ì¡°íšŒ ì¡°ê±´ì— ìµœì í™”ëœ ì¸ë±ìŠ¤ ë¶€ì¬</li>
            <li><strong>í†µê³„ ì¿¼ë¦¬ ë³‘ëª©</strong>: <code>popular_product_stat</code> ì‹¤ì‹œê°„ ê³„ì‚° ì‹œ ì „ì²´ <code>order_item</code> ìŠ¤ìº”</li>
        </ul>

        <h3>2.2 ë°ì´í„°ë² ì´ìŠ¤ ë³‘ëª©</h3>
        <p class="severity-medium">ğŸŸ¡ Medium: ì¸ë±ìŠ¤ ìµœì í™” ë¶€ì¡±</p>
        <pre>
            <code class="language-sql">
SELECT * FROM order WHERE user_id = ? AND status = ? ORDER BY created_at DESC;
-- user_idë§Œ ì¸ë±ìŠ¤ ì¡´ì¬ â†’ status ì¡°ê±´ì—ì„œ í’€ ìŠ¤ìº”

SELECT COUNT(*) FROM order_item oi 
JOIN order o ON oi.order_id = o.id 
WHERE oi.product_id = ? AND o.created_at BETWEEN ? AND ?;
-- created_at ì¸ë±ìŠ¤ ì—†ìŒ â†’ ì „ì²´ ìŠ¤ìº”

SELECT product_id, COUNT(*) FROM order_item 
GROUP BY product_id 
ORDER BY COUNT(*) DESC;
-- ë§¤ë²ˆ ì „ì²´ í…Œì´ë¸” ìŠ¤ìº”
            </code>
        </pre>
        <h4>ë³‘ëª© ì§€ì :</h4>
        <ul>
            <li><strong>ì¸ë±ìŠ¤ ëˆ„ë½</strong>: ë³µí•© ì¡°íšŒ ì¡°ê±´ì— ìµœì í™”ëœ ì¸ë±ìŠ¤ ë¶€ì¡±</li>
            <li><strong>ëŒ€ìš©ëŸ‰ ë°ì´í„° ì „ëµ í•„ìš”</strong>: ì£¼ë¬¸ ë°ì´í„° ì¦ê°€ì— ë”°ë¥¸ ì „ëµ ì—†ìŒ</li>
        </ul>

        <h3>2.3 ì• í”Œë¦¬ì¼€ì´ì…˜ ë³‘ëª©</h3>
        <p class="severity-medium">ğŸŸ¡ Medium: ìºì‹± ì „ëµ ë¶€ì¬</p>
        <pre>
            <code class="language-java">
public List<Product> getPopularProducts() {
    return orderItemRepository.findTopSellingProducts(LocalDate.now().minusDays(7));
}

public CouponInfo getCouponInfo(Long couponId) {
    return couponRepository.findById(couponId);
}
            </code>
        </pre>
        <h4>ë³‘ëª© ì§€ì :</h4>
        <ul>
            <li><strong>ìºì‹œ ì „ëµ ë¶€ì¬</strong>: ìì£¼ ì¡°íšŒë˜ëŠ” ìƒí’ˆ/ì¿ í° ì •ë³´ ìºì‹± ì—†ìŒ</li>
            <li><strong>ë°°ì¹˜ ì²˜ë¦¬ ë¶€ì¡±</strong>: í†µê³„ ë°ì´í„° ì‹¤ì‹œê°„ ê³„ì‚°ìœ¼ë¡œ ë¶€í•˜ ì¦ê°€</li>
        </ul>
    </section>

    <section id="jpa-tuning">
        <h2>3. JPA ì¿¼ë¦¬ íŠœë‹ ë° ì¸ë±ìŠ¤ ì„¤ê³„</h2>

        <h3>3.1 JPA ì„±ëŠ¥ ìµœì í™” ì „ëµ</h3>
        <h4>3.1.1 N+1 ë¬¸ì œ í•´ê²°</h4>
        <p class="severity-critical">ğŸ”´ ë¬¸ì œ: Lazy Loadingìœ¼ë¡œ ì¸í•œ N+1 ì¿¼ë¦¬</p>
        <pre>
            <code class="language-java">
@Entity
public class Order {
    @OneToMany(mappedBy = "order", fetch = FetchType.LAZY)
    private List<OrderItem> items;
    
    @ManyToOne(fetch = FetchType.LAZY)
    private User user;
}

public List<OrderDto> getOrders() {
    List<Order> orders = orderRepository.findAll();
    return orders.stream()
        .map(order -> {
            order.getItems().size();
            order.getUser().getName();
            return OrderDto.from(order);
        })
        .collect(Collectors.toList());
}
            </code>
        </pre>
        <p><strong>âœ… í•´ê²° ë°©ë²•: Fetch Joinê³¼ Entity Graph í™œìš©</strong></p>
        <pre>
            <code class="language-java">
@Repository
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    @Query("SELECT DISTINCT o FROM Order o " +
           "JOIN FETCH o.user u " +
           "JOIN FETCH o.items i " +
           "JOIN FETCH i.product p " +
           "WHERE o.createdAt >= :startDate")
    List<Order> findOrdersWithDetails(@Param("startDate") LocalDateTime startDate);
    
    @EntityGraph(attributePaths = {"user", "items", "items.product"})
    @Query("SELECT o FROM Order o WHERE o.user.id = :userId")
    List<Order> findOrdersByUserWithDetails(@Param("userId") Long userId);
}

@Service
public class OrderQueryService {
    
    @Transactional(readOnly = true)
    public List<OrderDto> getOrdersOptimized(Long userId) {
        List<Order> orders = orderRepository.findOrdersByUserWithDetails(userId);
        return orders.stream()
            .map(OrderDto::from)
            .collect(Collectors.toList());
    }
    
    @Transactional(readOnly = true)
    public Page<OrderDto> getOrdersPaged(Long userId, Pageable pageable) {
        Page<Long> orderIds = orderRepository.findOrderIdsByUserId(userId, pageable);
        List<Order> orders = orderRepository.findOrdersWithDetailsByIds(
            orderIds.getContent());
        return orderIds.map(id -> 
            orders.stream()
                .filter(order -> order.getId().equals(id))
                .findFirst()
                .map(OrderDto::from)
                .orElse(null)
        );
    }
}
            </code>
        </pre>

        <h4>3.1.2 Projection í™œìš©</h4>
        <p><strong>âœ… OrderSummaryProjection ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ í•„ìš”í•œ í•„ë“œë§Œ ì§€ì •, JPAê°€ ì´ í•„ë“œë“¤ë§Œ ì¡°íšŒí•˜ë„ë¡ ìµœì í™”ëœ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰</strong></p>
        <pre>
            <code class="language-java">
public interface OrderSummaryProjection {
    Long getId();
    String getUserName();
    BigDecimal getTotalAmount();
    String getOrderStatus();
    LocalDateTime getCreatedAt();
}

@Repository
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    @Query("SELECT o.id as id, u.name as userName, o.totalAmount as totalAmount, " +
           "os.status as orderStatus, o.createdAt as createdAt " +
           "FROM Order o JOIN o.user u JOIN o.order_state os " +
           "WHERE u.id = :userId")
    List<OrderSummaryProjection> findOrderSummaryByUserId(@Param("userId") Long userId);
}
            </code>
        </pre>

        <h3>3.2 ì¸ë±ìŠ¤ ì„¤ê³„ ì „ëµ</h3>
        <h4>3.2.1 Entity ê¸°ë°˜ ì¸ë±ìŠ¤ ì„¤ê³„</h4>
        <p><strong>âœ… JPAì—ì„œ @Tableê³¼ @Index ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ ì—”í‹°í‹° ì •ì˜ ì‹œ ì¸ë±ìŠ¤ë¥¼ ì¶”ê°€,<br>ì£¼ë¬¸ ìƒì„± ì‹œê°„, ì‚¬ìš©ì ID, ì£¼ë¬¸ ìƒíƒœ, ì´ ê¸ˆì•¡ ì¡°íšŒ ì¿¼ë¦¬ì— ëŒ€í•œ ì¸ë±ìŠ¤ ì„¤ê³„</strong></p>
        <pre>
            <code class="language-java">
@Entity
@Table(name = "order", indexes = {
    @Index(name = "idx_order_created_at", columnList = "created_at"),
    @Index(name = "idx_order_user_id", columnList = "user_id"),
    @Index(name = "idx_user_status_date", columnList = "user_id, status, created_at DESC")
})
public class Order {
    @Id
    private Long id;
    
    @Column(name = "user_id")
    private Long userId;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status", length = 20)
    private OrderStatus status;
    
    @Column(name = "total_amount", precision = 19, scale = 2)
    private BigDecimal totalAmount;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
}

@Entity
@Table(name = "order_item", indexes = {
    @Index(name = "idx_order_item_order_id", columnList = "order_id"),
    @Index(name = "idx_order_item_product_id", columnList = "product_id"),
    @Index(name = "idx_product_created_quantity", 
           columnList = "product_id, created_at DESC, quantity")
})
public class OrderItem {
    @Id
    private Long id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id")
    private Order order;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "product_id")
    private Product product;
    
    private Integer quantity;
    private BigDecimal price;
    private LocalDateTime createdAt;
}
            </code>
        </pre>

        <h4>3.2.2 ì¿¼ë¦¬ íŒ¨í„´ ì¸ë±ìŠ¤ ìµœì í™”</h4>
        <h5><strong>ì¿¼ë¦¬ì— ëŒ€í•œ ì¸ë±ìŠ¤ ì„¤ê³„</strong></h5>
        <p><strong>âœ… í˜ì´ì§• ì¿¼ë¦¬: ì‚¬ìš©ìë³„ ì£¼ë¬¸ ëª©ë¡ì€ í˜ì´ì§€ ë‹¨ìœ„ë¡œ ì¡°íšŒë˜ë‹ˆê¹Œ user_idì™€ created_at DESCë¥¼ ì¸ë±ìŠ¤ë¡œ ë¬¶ì–´ ë¹ ë¥´ê²Œ ì •ë ¬ ë° í•„í„°ë§.<br/>
            âœ… ê²€ìƒ‰ ì¿¼ë¦¬: ìƒí’ˆ ê²€ìƒ‰ì€ í‚¤ì›Œë“œ ê¸°ë°˜ì´ ë§ì•„ FULLTEXT ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©.<br/>
            âœ… ë³µí•© ì¸ë±ìŠ¤: WHERE ì¡°ê±´, JOIN, ORDER BYë¥¼ ëª¨ë‘ ì»¤ë²„í•˜ë„ë¡ ì»¬ëŸ¼ ìˆœì„œë¥¼ ì‹ ì¤‘íˆ ì„¤ê³„(ìì£¼ í•„í„°ë§ë˜ëŠ” ì»¬ëŸ¼ì„ ì•ì— ë°°ì¹˜).</strong></p>
        <pre>
            <code class="language-sql">
CREATE INDEX idx_order_paging_cover 
ON order (user_id, created_at DESC, id, total_amount, status);

CREATE FULLTEXT INDEX idx_product_search ON product (name, description);
CREATE INDEX idx_product_search_filter 
ON product (status, price, category_id, created_at DESC);
            </code>
        </pre>
        <pre>
            <code class="language-java">
@Repository
public interface ProductRepository extends JpaRepository<Product, Long> {
    
    @Query(value = "SELECT * FROM product p " +
                   "WHERE MATCH(p.name, p.description) AGAINST(:keyword IN BOOLEAN MODE) " +
                   "AND p.status = 'ACTIVE' " +
                   "ORDER BY p.created_at DESC",
           nativeQuery = true)
    List<Product> searchProductsFullText(@Param("keyword") String keyword);
}
            </code>
        </pre>
    </section>

    <section id="normalization">
        <h2>4. ê¸°ë³¸ ì •ê·œí™” ê°œì„ </h2>
        <h3>4.1 ëª©ì ê³¼ ë°°ê²½</h3>
        <p><strong>ë¬¸ì œì :</strong></p>
        <ul>
            <li><code>product</code> í…Œì´ë¸”ì— ì¬ê³  ì •ë³´ í¬í•¨</li>
            <li><code>order</code> í…Œì´ë¸”ì— ìƒíƒœ ì •ë³´ í¬í•¨</li>
        </ul>

        <h3>4.2 ê°œì„  êµ¬ì¡°</h3>
        <div class="mermaid">
            erDiagram
                user {
                    bigint id PK
                    varchar name
                    timestamp created_at
                    timestamp updated_at
                }
                
                balance {
                    bigint id PK
                    bigint user_id FK "UNIQUE"
                    decimal amount "DECIMAL(19,2)"
                    long version
                    timestamp created_at
                    timestamp updated_at
                }
                
                product {
                    bigint id PK
                    bigint category_id FK
                    varchar name
                    decimal price "DECIMAL(19,2)"
                    varchar status "ENUM"
                    timestamp created_at
                    timestamp updated_at
                    long version
                }
                
                product_stock {
                    bigint product_id PK
                    int stock
                    int reserved_stock
                    long version
                    timestamp last_updated
                }
                
                order {
                    bigint id PK
                    bigint user_id FK
                    decimal total_amount "DECIMAL(19,2)"
                    timestamp created_at
                    timestamp updated_at
                    long version
                }
                
                order_state {
                    bigint order_id PK
                    varchar status "ENUM"
                    long version
                    timestamp last_updated
                }
                
                order_item {
                    bigint id PK
                    bigint order_id FK
                    bigint product_id FK
                    int quantity
                    decimal price "DECIMAL(19,2)"
                    timestamp created_at
                    timestamp updated_at
                }
                
                payment {
                    bigint id PK
                    bigint order_id FK
                    bigint user_id FK
                    bigint coupon_id FK
                    varchar payment_method
                    timestamp created_at
                    timestamp updated_at
                }
                
                payment_state {
                    bigint payment_id PK
                    decimal amount "DECIMAL(19,2)"
                    varchar status "ENUM"
                    long version
                    timestamp last_updated
                }
                
                coupon {
                    bigint id PK
                    bigint product_id FK
                    varchar code
                    decimal discount_rate "DECIMAL(5,2)"
                    int max_issuance
                    int issued_count
                    datetime start_date
                    datetime end_date
                    varchar status "ENUM"
                    timestamp created_at
                    timestamp updated_at
                }
                
                coupon_history {
                    bigint id PK
                    bigint user_id FK
                    bigint coupon_id FK
                    bigint order_id FK
                    datetime issued_at
                    datetime used_at
                    varchar status "ENUM"
                    timestamp created_at
                    timestamp updated_at
                }
                
                popular_product_stat {
                    bigint product_id PK
                    int sales_count
                    datetime calculated_at
                }
                
                user ||--|| balance : "1:1"
                user ||--o{ order : "1:N"
                user ||--o{ payment : "1:N"
                user ||--o{ coupon_history : "1:N"
                
                product ||--|| product_stock : "1:1"
                product ||--o{ order_item : "1:N"
                product ||--o{ coupon : "1:N"
                product ||--|| popular_product_stat : "1:1"
                
                order ||--|| order_state : "1:1"
                order ||--o{ order_item : "1:N"
                order ||--o{ payment : "1:N"
                order ||--o{ coupon_history : "used_order"
                
                payment ||--|| payment_state : "1:1"
                coupon ||--o{ coupon_history : "1:N"
                coupon ||--o{ payment : "1:N"
        </div>

        <h3>4.3 êµ¬í˜„ ë°©ë²•</h3>
        <h4>4.3.1 ìƒˆ í…Œì´ë¸” ìƒì„±</h4>
        <pre>
            <code class="language-sql">

CREATE TABLE product_stock (
    product_id BIGINT PRIMARY KEY,
    stock INT NOT NULL DEFAULT 0,
    reserved_stock INT NOT NULL DEFAULT 0,
    version BIGINT NOT NULL DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES product(id) ON DELETE CASCADE,
    INDEX idx_stock_reserved (stock, reserved_stock)
);

CREATE TABLE order_state (
    order_id BIGINT PRIMARY KEY,
    status ENUM('PENDING', 'PAID', 'SHIPPED', 'DELIVERED', 'CANCELLED') NOT NULL,
    version BIGINT NOT NULL DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES order(id) ON DELETE CASCADE,
    INDEX idx_status_updated (status, last_updated DESC)
);

CREATE TABLE payment_state (
    payment_id BIGINT PRIMARY KEY,
    amount DECIMAL(19,2) NOT NULL,
    status ENUM('PENDING', 'COMPLETED', 'FAILED', 'REFUNDED') NOT NULL,
    version BIGINT NOT NULL DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (payment_id) REFERENCES payment(id) ON DELETE CASCADE,
    INDEX idx_status_updated (status, last_updated DESC)
);
            </code>
        </pre>

        <h3>4.4 ì¥ë‹¨ì </h3>
        <h4>ì¥ì :</h4>
        <ul>
            <li>âœ… <strong>ë°ì´í„° ì¼ê´€ì„±</strong>: ì¬ê³ ì™€ ìƒíƒœ ì •ë³´ ë¶„ë¦¬ë¡œ ì •í•©ì„± í–¥ìƒ</li>
            <li>âœ… <strong>ìœ ì§€ë³´ìˆ˜ì„±</strong>: ë„ë©”ì¸ë³„ ì±…ì„ ë¶„ë¦¬</li>
        </ul>
        <h4>ë‹¨ì :</h4>
        <ul>
            <li>âŒ <strong>ë§ˆì´ê·¸ë ˆì´ì…˜ ë³µì¡ë„</strong>: ê¸°ì¡´ ë°ì´í„° ì´ì „ í•„ìš”</li>
            <li>âŒ <strong>ì¡°íšŒ ì„±ëŠ¥</strong>: JOIN ì¦ê°€ ê°€ëŠ¥</li>
        </ul>
    </section>

    <section id="cqrs">
        <h2>5. CQRS íŒ¨í„´ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì¬ì„¤ê³„</h2>
        <h3>5.1 ëª©ì ê³¼ ë°°ê²½</h3>
        <p>ë³µì¡í•œ ì¡°íšŒ ì¿¼ë¦¬ì™€ ë‹¤ì¤‘ í…Œì´ë¸” JOINìœ¼ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ CQRS(Command Query Responsibility Segregation)ë¥¼ ë„ì…í•˜ì—¬ ì½ê¸°/ì“°ê¸° ëª¨ë¸ì„ ë¶„ë¦¬</p>

        <h3>5.2 ê°œì„  êµ¬ì¡°</h3>
        <div class="mermaid">
            erDiagram
                subgraph "Command Side (ì“°ê¸° ëª¨ë¸)"
                    user {
                        bigint id PK
                        varchar name
                        timestamp created_at
                        timestamp updated_at
                        long version
                    }
                    
                    product {
                        bigint id PK
                        bigint category_id FK
                        varchar name
                        decimal price "DECIMAL(19,2)"
                        varchar status "ENUM"
                        timestamp created_at
                        timestamp updated_at
                        long version
                    }
                    
                    product_stock {
                        bigint product_id PK
                        int stock
                        int reserved_stock
                        long version
                        timestamp last_updated
                    }
                    
                    order {
                        bigint id PK
                        bigint user_id FK
                        decimal total_amount "DECIMAL(19,2)"
                        timestamp created_at
                        timestamp updated_at
                        long version
                    }
                    
                    order_state {
                        bigint order_id PK
                        varchar status "ENUM"
                        long version
                        timestamp last_updated
                    }
                    
                    order_item {
                        bigint id PK
                        bigint order_id FK
                        bigint product_id FK
                        int quantity
                        decimal price "DECIMAL(19,2)"
                        timestamp created_at
                        timestamp updated_at
                    }
                    
                    payment {
                        bigint id PK
                        bigint order_id FK
                        bigint user_id FK
                        bigint coupon_id FK
                        varchar payment_method
                        timestamp created_at
                        timestamp updated_at
                    }
                    
                    payment_state {
                        bigint payment_id PK
                        decimal amount "DECIMAL(19,2)"
                        varchar status "ENUM"
                        long version
                        timestamp last_updated
                    }
                end
                
                subgraph "Query Side (ì½ê¸° ëª¨ë¸)"
                    order_read_view {
                        bigint order_id PK
                        varchar user_name
                        decimal total_amount
                        varchar order_status
                        int total_items
                        varchar product_names
                        varchar first_product_name
                        varchar payment_status
                        decimal paid_amount
                        timestamp order_date
                        timestamp updated_at
                    }
                    
                    product_read_view {
                        bigint product_id PK
                        varchar name
                        decimal price
                        int available_stock
                        varchar status
                        boolean has_active_coupon
                        decimal max_discount_rate
                        int sales_count
                        timestamp last_updated
                    }
                end
                
                user ||--o{ order : "1:N"
                user ||--o{ payment : "1:N"
                product ||--|| product_stock : "1:1"
                product ||--o{ order_item : "1:N"
                order ||--|| order_state : "1:1"
                order ||--o{ order_item : "1:N"
                order ||--o{ payment : "1:N"
                payment ||--|| payment_state : "1:1"
        </div>

        <h3>5.3 êµ¬í˜„ ë°©ë²•</h3>
        <h4>5.3.1 ì½ê¸° ì „ìš© ë·° í…Œì´ë¸”</h4>
        <pre>
            <code class="language-sql">
CREATE TABLE order_read_view (
    order_id BIGINT PRIMARY KEY,
    user_name VARCHAR(100) NOT NULL,
    total_amount DECIMAL(19,2) NOT NULL,
    order_status VARCHAR(20) NOT NULL,
    total_items INT NOT NULL,
    product_names TEXT,
    first_product_name VARCHAR(255),
    payment_status VARCHAR(20),
    paid_amount DECIMAL(19,2),
    order_date TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    INDEX idx_status_date (order_status, order_date DESC)
);

CREATE TABLE product_read_view (
    product_id BIGINT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    price DECIMAL(19,2) NOT NULL,
    available_stock INT NOT NULL,
    status VARCHAR(20) NOT NULL,
    has_active_coupon BOOLEAN DEFAULT FALSE,
    max_discount_rate DECIMAL(5,2) DEFAULT 0.00,
    sales_count INT DEFAULT 0,
    last_updated TIMESTAMP NOT NULL,
    INDEX idx_status_stock (status, available_stock DESC)
);
            </code>
        </pre>

        <h4>5.3.2 ë°ì´í„° ë™ê¸°í™”</h4>
        <pre>
            <code class="language-java">
@Component
public class ReadViewSyncService {
    
    @EventListener
    @Async
    public void syncOrderReadView(OrderCreatedEvent event) {
        Order order = event.getOrder();
        OrderState orderState = orderStateRepository.findById(order.getId()).orElseThrow();
        
        OrderReadView readView = OrderReadView.builder()
            .orderId(order.getId())
            .userName(order.getUser().getName())
            .totalAmount(order.getTotalAmount())
            .orderStatus(orderState.getStatus().name())
            .totalItems(order.getItems().size())
            .productNames(extractProductNames(order.getItems()))
            .firstProductName(order.getItems().get(0).getProduct().getName())
            .orderDate(order.getCreatedAt())
            .updatedAt(LocalDateTime.now())
            .build();
            
        orderReadViewRepository.save(readView);
    }
}
            </code>
        </pre>

        <h3>5.4 ì¥ë‹¨ì </h3>
        <h4>ì¥ì :</h4>
        <ul>
            <li>âœ… <strong>ì¡°íšŒ ì„±ëŠ¥</strong>: ë³µì¡í•œ ì¡°íšŒ ì¿¼ë¦¬ ì œê±°</li>
            <li>âœ… <strong>ìœ ì—°ì„±</strong>: ì½ê¸°/ì“°ê¸° ëª¨ë¸ ë¶„ë¦¬ë¡œ ìµœì í™” ìš©ì´</li>
            <li>âœ… <strong>í™•ì¥ì„±</strong>: ì½ê¸° ì „ìš© ë·°ë¡œ ë¶€í•˜ ë¶„ì‚°</li>
        </ul>
        <h4>ë‹¨ì :</h4>
        <ul>
            <li>âŒ <strong>ë°ì´í„° ì¼ê´€ì„±</strong>: ë™ê¸°í™” ì§€ì—° ê°€ëŠ¥</li>
            <li>âŒ <strong>ì €ì¥ì†Œ ë¹„ìš©</strong>: ì¤‘ë³µ ë°ì´í„°ë¡œ ìš©ëŸ‰ ì¦ê°€</li>
        </ul>
    </section>

    <section id="implementation-guidelines">
        <h2>6. êµ¬í˜„ ê°€ì´ë“œë¼ì¸</h2>
        <div class="mermaid">
            graph TD
                Start[í˜„ì¬ êµ¬ì¡°] --> Phase1[JPA ì¿¼ë¦¬ íŠœë‹ ë° ì¸ë±ìŠ¤ ì„¤ê³„]
                Phase1 --> Phase2[ê¸°ë³¸ ì •ê·œí™” ê°œì„ ]
                Phase2 --> Phase3[CQRS ë„ì…]
                Phase3 --> Complete[ê°œì„  ì™„ë£Œ]
        </div>
    </section>

    <section id="conclusion">
        <h2>7. ê²°ë¡ </h2>
        <p>JPA ì¿¼ë¦¬ íŠœë‹ìœ¼ë¡œ N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ê³ , ì¸ë±ìŠ¤ ì„¤ê³„ë¡œ ì¡°íšŒ ì„±ëŠ¥ì„ ìµœì í™”í•©ë‹ˆë‹¤. ì •ê·œí™” ê°œì„ ìœ¼ë¡œ ë°ì´í„° ì¼ê´€ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì´ë©°, CQRS ë„ì…ìœ¼ë¡œ ì½ê¸°/ì“°ê¸° ì„±ëŠ¥ì„ ë¶„ë¦¬í•˜ì—¬ ì‹œìŠ¤í…œ í™•ì¥ì„±ì„ í™•ë³´í•©ë‹ˆë‹¤.</p>
    </section>
</body>
</html>