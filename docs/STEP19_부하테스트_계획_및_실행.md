# 부하테스트 계획 및 실행

## 1. 테스트 목적

### 성능 한계점 파악
- 시스템이 처리할 수 있는 최대 동시 사용자 수 측정
- API별 응답 시간 및 처리량 측정
- 리소스 사용률 모니터링 (CPU, 메모리, DB 커넥션)

### 동시성 제어 검증
- 재고 관리 시 데이터 정합성 확인
- 쿠폰 발급 시 중복 발급 방지 확인
- 동시 주문 처리 시 트랜잭션 안정성 확인

## 2. 테스트 대상

### 시스템 구성
- **애플리케이션**: Spring Boot 3.4.1 + Java 21
- **데이터베이스**: MySQL 8.0 + Redis 7.4
- **메시지 큐**: Kafka 2.8+
- **커넥션 풀**: HikariCP (최대 50 커넥션)

### 주요 테스트 API
| API | 목적 | 검증 포인트 |
|-----|------|------------|
| `GET /api/product/list` | 상품 목록 조회 | 캐시 효율성, 응답 시간 |
| `POST /api/orders` | 주문 생성 | 재고 동시성 제어 |
| `POST /api/orders/{id}/pay` | 결제 처리 | 트랜잭션 안정성 |
| `POST /api/coupons/{id}/issue` | 쿠폰 발급 | 동시 발급 제어 |

## 3. 테스트 시나리오

### 3.1 상품 조회 부하 테스트
**스크립트**: `01-product-load-test.js`

**목적**: 가장 빈번한 API인 상품 조회의 성능 및 캐시 효율성 검증

**부하 패턴**:
- 워밍업: 1분간 20 VUs
- 정상 부하: 3분간 50 VUs
- 높은 부하: 2분간 100 VUs
- 쿨다운: 1분간 0 VUs로 감소

**시나리오 구성**:
- 상품 목록 조회 + 상세 조회
- 인기 상품 조회 (캐시 히트율 확인)


### 3.2 주문 동시성 테스트
**스크립트**: `02-order-concurrency-test.js`

**목적**: 동시 주문 시 재고 관리 정합성 및 결제 처리 안정성 검증

**시나리오**:
1. **동시 주문 (concurrent_orders)**
   - 50 VUs가 2분간 같은 상품에 대해 동시 주문
   - 재고 동시성 제어 검증
   
2. **일반 주문 플로우 (normal_flow)**
   - 5-30 VUs로 점진적 증가
   - 상품 조회 → 주문 생성 → 잔액 충전(필요시) → 결제

### 3.3 쿠폰 스파이크 테스트
**스크립트**: `03-coupon-spike-test.js`

**목적**: 선착순 쿠폰 발급 시 동시성 제어 및 정합성 검증

**부하 패턴**:
- 대기: 10초간 10 VUs
- 스파이크: 5초만에 300 VUs로 급증
- 유지: 30초간 300 VUs 유지
- 정상화: 10초간 10 VUs로 감소

**검증 항목**:
- 한정 수량(100개) 초과 발급 방지
- 사용자당 중복 발급 방지
- 스파이크 상황에서도 시스템 안정성 유지


### 3.4 종합 부하 테스트
**스크립트**: `04-comprehensive-load-test.js`

**목적**: 실제 운영 패턴을 가정한 혼합 트래픽으로 전체 시스템 성능 검증

**부하 패턴**:
- 워밍업: 2분간 50 VUs
- 정상 부하: 5분간 100 VUs
- 피크 부하: 3분간 150 VUs
- 정상화: 2분간 50 VUs
- 쿨다운: 1분간 0 VUs

**트래픽 분배**:
- 상품 조회 (목록 + 상세)
- 주문 처리 (생성 + 결제)
- 쿠폰 처리 (발급 + 조회)


## 4. 모니터링 지표

### 애플리케이션 메트릭
- **Spring Boot Admin**: http://localhost:9090
- **Actuator Health**: http://localhost:8080/actuator/health
- **Actuator Metrics**: http://localhost:8080/actuator/metrics

### 수집 메트릭
- **응답 시간**: 평균, P50, P95, P99
- **처리량**: 초당 요청 수 (RPS)
- **에러율**: HTTP 상태코드별 분포
- **리소스 사용률**: CPU, 메모리, DB 커넥션 풀

### 도메인별 검증
- **상품**: 캐시 히트율, 조회 성능
- **주문**: 재고 정합성, 트랜잭션 성공률
- **쿠폰**: 발급 정확성, 동시성 제어
- **결제**: 잔액 정합성, 처리 안정성

## 5. 예상 병목 지점

### 데이터베이스
- 복잡한 JOIN 쿼리 (주문 내역 조회)
- 동시 UPDATE 시 락 경합 (재고, 잔액)
- 커넥션 풀 고갈 가능성

### 애플리케이션
- 동시성 제어 로직 (분산락 획득 대기)
- 대량 데이터 직렬화/역직렬화
- Kafka 이벤트 발행 지연

### 캐시
- 캐시 미스 시 DB 부하 증가
- Redis 연결 풀 제한
- 캐시 무효화 시점의 일시적 부하
