# Kafka Factory íŒ¨í„´ í•™ìŠµ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

Spring Kafkaì—ì„œ Factory íŒ¨í„´ì€ Kafka Consumerì™€ Producerë¥¼ ìƒì„±í•˜ê³  êµ¬ì„±í•˜ëŠ” í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜ì…ë‹ˆë‹¤. ì´ ë¬¸ì„œì—ì„œëŠ” Factory íŒ¨í„´ì´ ì™œ í•„ìš”í•œì§€, ì‚¬ìš©í•˜ì§€ ì•Šì„ ë•Œì˜ ë¬¸ì œì , ê·¸ë¦¬ê³  Factory íŒ¨í„´ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë¬¸ì œë“¤ì„ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.

## ğŸ¯ Factory íŒ¨í„´ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ì´ìœ 

### 1. êµ¬ì„±(Configuration)ì˜ ì¤‘ì•™í™”ì™€ ì¼ê´€ì„±

**Factory íŒ¨í„´ ì—†ì´:**
```java
// ê° Consumerë§ˆë‹¤ ê°œë³„ì ìœ¼ë¡œ êµ¬ì„± - ì¼ê´€ì„± ì—†ìŒ
@Component
public class OrderConsumer {
    
    @KafkaListener(topics = "order-completed")
    public void handleOrder(ConsumerRecord<String, String> record) {
        // ë§¤ë²ˆ ë‹¤ë¥¸ ì„¤ì •ìœ¼ë¡œ Consumerê°€ ìƒì„±ë  ìˆ˜ ìˆìŒ
        // ì§ë ¬í™”/ì—­ì§ë ¬í™” ì„¤ì •ì´ ë¶ˆì¼ì¹˜í•  ìˆ˜ ìˆìŒ
        ObjectMapper mapper = new ObjectMapper(); // ë§¤ë²ˆ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤
        // ...
    }
}
```

**Factory íŒ¨í„´ ì‚¬ìš©:**
```java
@Configuration
public class KafkaConfig {
    
    // ëª¨ë“  Consumerê°€ ë™ì¼í•œ ì„¤ì •ì„ ê³µìœ 
    @Bean
    public ConsumerFactory<String, OrderCompletedEvent> orderCompletedConsumerFactory() {
        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ErrorHandlingDeserializer.class);
        props.put(ErrorHandlingDeserializer.VALUE_DESERIALIZER_CLASS, JsonDeserializer.class);
        props.put(JsonDeserializer.VALUE_DEFAULT_TYPE, OrderCompletedEvent.class);
        props.put(JsonDeserializer.TRUSTED_PACKAGES, "kr.hhplus.be.server.domain.event");
        
        return new DefaultKafkaConsumerFactory<>(props);
    }
    
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, OrderCompletedEvent> 
            orderCompletedKafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, OrderCompletedEvent> factory = 
            new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(orderCompletedConsumerFactory());
        factory.setConcurrency(3); // ëª¨ë“  Consumerê°€ ë™ì¼í•œ ë™ì‹œì„± ì„¤ì •
        return factory;
    }
}
```

### 2. íƒ€ì… ì•ˆì •ì„± (Type Safety)

**Factory íŒ¨í„´ ì—†ì´:**
```java
@KafkaListener(topics = "order-completed")
public void handleOrder(ConsumerRecord<String, Object> record) {
    // ëŸ°íƒ€ì„ì— íƒ€ì… ìºìŠ¤íŒ… í•„ìš” - ClassCastException ìœ„í—˜
    try {
        OrderCompletedEvent event = (OrderCompletedEvent) record.value();
        // íƒ€ì… ë¶ˆì¼ì¹˜ ì‹œ ëŸ°íƒ€ì„ ì—ëŸ¬
    } catch (ClassCastException e) {
        // íƒ€ì… ì•ˆì •ì„± ë¬¸ì œë¡œ ì¸í•œ ì—ëŸ¬ ì²˜ë¦¬ í•„ìš”
    }
}
```

**Factory íŒ¨í„´ ì‚¬ìš©:**
```java
@KafkaListener(topics = "order-completed", 
               containerFactory = "orderCompletedKafkaListenerContainerFactory")
public void handleOrder(OrderCompletedEvent event) {
    // ì»´íŒŒì¼ íƒ€ì„ì— íƒ€ì… ì•ˆì •ì„± ë³´ì¥
    // eventëŠ” ì´ë¯¸ ì˜¬ë°”ë¥¸ íƒ€ì…ìœ¼ë¡œ ì—­ì§ë ¬í™”ë¨
    Long orderId = event.getOrderId(); // ì•ˆì „í•œ ì ‘ê·¼
}
```

### 3. ì—ëŸ¬ ì²˜ë¦¬ì˜ í‘œì¤€í™”

**Factory íŒ¨í„´ ì—†ì´:**
```java
@KafkaListener(topics = "order-completed")
public void handleOrder(ConsumerRecord<String, String> record) {
    try {
        ObjectMapper mapper = new ObjectMapper();
        OrderCompletedEvent event = mapper.readValue(record.value(), OrderCompletedEvent.class);
        // ê° Consumerë§ˆë‹¤ ê°œë³„ì ì¸ ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§
    } catch (JsonProcessingException e) {
        // ì¼ê´€ë˜ì§€ ì•Šì€ ì—ëŸ¬ ì²˜ë¦¬
        log.error("ì—­ì§ë ¬í™” ì‹¤íŒ¨: {}", e.getMessage());
        // ë©”ì‹œì§€ ì†ì‹¤ ìœ„í—˜
    }
}
```

**Factory íŒ¨í„´ ì‚¬ìš©:**
```java
// Factoryì—ì„œ ErrorHandlingDeserializer ì„¤ì •
props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ErrorHandlingDeserializer.class);
props.put(ErrorHandlingDeserializer.VALUE_DESERIALIZER_CLASS, JsonDeserializer.class);

// Consumerì—ì„œëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ë§Œ ì§‘ì¤‘
@KafkaListener(topics = "order-completed", 
               containerFactory = "orderCompletedKafkaListenerContainerFactory")
public void handleOrder(OrderCompletedEvent event) {
    // ì—­ì§ë ¬í™” ì—ëŸ¬ëŠ” Factory ë ˆë²¨ì—ì„œ ìë™ ì²˜ë¦¬
    // Dead Letter Topicìœ¼ë¡œ ìë™ ë¼ìš°íŒ… ê°€ëŠ¥
    processOrder(event);
}
```

## ğŸš« Factory íŒ¨í„´ì„ ì‚¬ìš©í•˜ì§€ ì•Šì„ ë•Œì˜ ë¬¸ì œì 

### 1. ì„¤ì • ì¤‘ë³µê³¼ ë¶ˆì¼ì¹˜ ë¬¸ì œ

```java
// ë¬¸ì œê°€ ìˆëŠ” ì½”ë“œ - ê° Consumerë§ˆë‹¤ ë‹¤ë¥¸ ì„¤ì •
@Component
public class OrderConsumer {
    @KafkaListener(topics = "order-completed")
    public void handleOrder(ConsumerRecord<String, String> record) {
        // Consumer A: Jackson ObjectMapper ì‚¬ìš©
        ObjectMapper mapper = new ObjectMapper();
        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
    }
}

@Component
public class PaymentConsumer {
    @KafkaListener(topics = "payment-completed")
    public void handlePayment(ConsumerRecord<String, String> record) {
        // Consumer B: ë‹¤ë¥¸ ObjectMapper ì„¤ì • ì‚¬ìš©
        ObjectMapper mapper = new ObjectMapper();
        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, true);
        // ë™ì¼í•œ ì´ë²¤íŠ¸ êµ¬ì¡°ë¼ë„ ë‹¤ë¥´ê²Œ ì²˜ë¦¬ë  ìˆ˜ ìˆìŒ
    }
}
```

### 2. ë©”ëª¨ë¦¬ ë° ì„±ëŠ¥ ë¬¸ì œ

```java
// ë¬¸ì œê°€ ìˆëŠ” ì½”ë“œ - ë¦¬ì†ŒìŠ¤ ë‚­ë¹„
@KafkaListener(topics = "order-completed")
public void handleOrder(ConsumerRecord<String, String> record) {
    // ë©”ì‹œì§€ ì²˜ë¦¬í•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ ObjectMapper ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    ObjectMapper mapper = new ObjectMapper(); // ë©”ëª¨ë¦¬ ë‚­ë¹„
    
    // Consumer ì„¤ì •ë„ ë§¤ë²ˆ ìƒˆë¡­ê²Œ ì²˜ë¦¬
    // ì»¤ë„¥ì…˜ í’€ë§ ì—†ìŒ - ì„±ëŠ¥ ì €í•˜
}
```

### 3. ì—ëŸ¬ ì²˜ë¦¬ í‘œì¤€í™” ë¶€ì¬

```java
// ë¬¸ì œê°€ ìˆëŠ” ì½”ë“œ - ì¼ê´€ë˜ì§€ ì•Šì€ ì—ëŸ¬ ì²˜ë¦¬
@Component
public class InconsistentErrorHandling {
    
    @KafkaListener(topics = "order-completed")
    public void handleOrder(ConsumerRecord<String, String> record) {
        try {
            // Consumer A: ì—ëŸ¬ ì‹œ ë¡œê·¸ë§Œ ì¶œë ¥
            ObjectMapper mapper = new ObjectMapper();
            OrderCompletedEvent event = mapper.readValue(record.value(), OrderCompletedEvent.class);
        } catch (Exception e) {
            log.error("Order processing failed", e);
            // ë©”ì‹œì§€ ì†ì‹¤
        }
    }
    
    @KafkaListener(topics = "payment-completed")
    public void handlePayment(ConsumerRecord<String, String> record) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            PaymentCompletedEvent event = mapper.readValue(record.value(), PaymentCompletedEvent.class);
        } catch (Exception e) {
            log.error("Payment processing failed", e);
            throw e; // Consumer B: ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì§ - ì¬ì‹œë„ ë¬´í•œë°˜ë³µ ìœ„í—˜
        }
    }
}
```

## âœ… Factory íŒ¨í„´ìœ¼ë¡œ ê°œì„ í•  ìˆ˜ ìˆëŠ” ë¬¸ì œë“¤

### 1. êµ¬ì„± ê´€ë¦¬ì˜ ì¤‘ì•™í™”

```java
@Configuration
public class KafkaConfig {
    
    // ê³µí†µ ì„¤ì •ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬
    private Map<String, Object> getCommonConsumerProps() {
        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        props.put(ConsumerConfig.GROUP_ID_CONFIG, "default-group");
        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");
        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        return props;
    }
    
    // íƒ€ì…ë³„ íŠ¹í™”ëœ Factory
    @Bean
    public ConsumerFactory<String, OrderCompletedEvent> orderCompletedConsumerFactory() {
        Map<String, Object> props = getCommonConsumerProps();
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ErrorHandlingDeserializer.class);
        props.put(ErrorHandlingDeserializer.VALUE_DESERIALIZER_CLASS, JsonDeserializer.class);
        props.put(JsonDeserializer.VALUE_DEFAULT_TYPE, OrderCompletedEvent.class);
        return new DefaultKafkaConsumerFactory<>(props);
    }
}
```

### 2. ì„±ëŠ¥ ìµœì í™”

```java
@Configuration
public class OptimizedKafkaConfig {
    
    // ì»¤ë„¥ì…˜ í’€ë§ê³¼ ë¦¬ì†ŒìŠ¤ ì¬ì‚¬ìš©
    @Bean
    public ConsumerFactory<String, OrderCompletedEvent> orderCompletedConsumerFactory() {
        Map<String, Object> props = new HashMap<>();
        // ... ê¸°ë³¸ ì„¤ì •
        
        // ì»¤ë„¥ì…˜ í’€ ì„¤ì •
        props.put(ConsumerConfig.CONNECTIONS_MAX_IDLE_MS_CONFIG, 300000);
        props.put(ConsumerConfig.METADATA_MAX_AGE_CONFIG, 300000);
        
        // ë°°ì¹˜ ì²˜ë¦¬ ìµœì í™”
        props.put(ConsumerConfig.FETCH_MIN_BYTES_CONFIG, 1024);
        props.put(ConsumerConfig.FETCH_MAX_WAIT_MS_CONFIG, 500);
        
        return new DefaultKafkaConsumerFactory<>(props);
    }
    
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, OrderCompletedEvent> 
            orderCompletedKafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, OrderCompletedEvent> factory = 
            new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(orderCompletedConsumerFactory());
        
        // ë™ì‹œì„± ìµœì í™”
        factory.setConcurrency(3);
        factory.setBatchListener(true); // ë°°ì¹˜ ì²˜ë¦¬ í™œì„±í™”
        
        return factory;
    }
}
```

### 3. ëª¨ë‹ˆí„°ë§ê³¼ ë©”íŠ¸ë¦­ ìˆ˜ì§‘

```java
@Configuration
public class MonitoringKafkaConfig {
    
    @Bean
    public ConsumerFactory<String, OrderCompletedEvent> orderCompletedConsumerFactory() {
        Map<String, Object> props = new HashMap<>();
        // ... ê¸°ë³¸ ì„¤ì •
        
        // ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í™œì„±í™”
        props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);
        props.put(ConsumerConfig.ISOLATION_LEVEL_CONFIG, "read_committed");
        
        return new DefaultKafkaConsumerFactory<>(props);
    }
    
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, OrderCompletedEvent> 
            orderCompletedKafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, OrderCompletedEvent> factory = 
            new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(orderCompletedConsumerFactory());
        
        // ì—ëŸ¬ í•¸ë“¤ë§ê³¼ ëª¨ë‹ˆí„°ë§
        factory.setErrorHandler(new SeekToCurrentErrorHandler(
            new FixedBackOff(1000L, 3))); // ì¬ì‹œë„ ì •ì±…
        
        // ì»¨í…Œì´ë„ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        factory.setContainerCustomizer(container -> {
            container.setupMessageListener((MessageListener<String, OrderCompletedEvent>) record -> {
                // ë©”ì‹œì§€ ì²˜ë¦¬ ì „ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
                Metrics.counter("kafka.message.received", "topic", record.topic()).increment();
            });
        });
        
        return factory;
    }
}
```

## ğŸ¯ ì‹¤ì œ í”„ë¡œì íŠ¸ ì ìš© ì˜ˆì‹œ

### í˜„ì¬ í”„ë¡œì íŠ¸ì˜ Factory êµ¬ì„±

```java
@Configuration
@EnableKafka
public class KafkaConfig {
    
    @Value("${spring.kafka.bootstrap-servers}")
    private String bootstrapServers;
    
    // ì£¼ë¬¸ ì™„ë£Œ ì´ë²¤íŠ¸ Consumer Factory
    @Bean
    public ConsumerFactory<String, OrderCompletedEvent> orderCompletedConsumerFactory() {
        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        props.put(ConsumerConfig.GROUP_ID_CONFIG, "order-ranking-group");
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ErrorHandlingDeserializer.class);
        props.put(ErrorHandlingDeserializer.VALUE_DESERIALIZER_CLASS, JsonDeserializer.class);
        props.put(JsonDeserializer.VALUE_DEFAULT_TYPE, OrderCompletedEvent.class);
        props.put(JsonDeserializer.TRUSTED_PACKAGES, "kr.hhplus.be.server.domain.event");
        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");
        
        return new DefaultKafkaConsumerFactory<>(props);
    }
    
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, OrderCompletedEvent> 
            orderCompletedKafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, OrderCompletedEvent> factory = 
            new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(orderCompletedConsumerFactory());
        factory.setConcurrency(3);
        return factory;
    }
    
    // ì´ë²¤íŠ¸ Consumerì—ì„œ ì‚¬ìš©
    @KafkaListener(topics = "order-completed", 
                   containerFactory = "orderCompletedKafkaListenerContainerFactory")
    public void handleOrderCompleted(OrderCompletedEvent event) {
        // íƒ€ì… ì•ˆì •ì„± ë³´ì¥ëœ ì´ë²¤íŠ¸ ì²˜ë¦¬
        // ì—ëŸ¬ ì²˜ë¦¬ëŠ” Factory ë ˆë²¨ì—ì„œ í‘œì¤€í™”ë¨
        // ì„±ëŠ¥ ìµœì í™”ëœ Consumer ì‚¬ìš©
    }
}
```

## ğŸ“Š Factory íŒ¨í„´ ì‚¬ìš© íš¨ê³¼

### Before vs After ë¹„êµ

| êµ¬ë¶„ | Factory íŒ¨í„´ ì—†ìŒ | Factory íŒ¨í„´ ì‚¬ìš© |
|------|------------------|-------------------|
| **íƒ€ì… ì•ˆì •ì„±** | ëŸ°íƒ€ì„ ìºìŠ¤íŒ… í•„ìš” | ì»´íŒŒì¼ íƒ€ì„ ë³´ì¥ |
| **ì„¤ì • ì¼ê´€ì„±** | Consumerë§ˆë‹¤ ë‹¤ë¦„ | ì¤‘ì•™ì—ì„œ í†µì¼ ê´€ë¦¬ |
| **ì—ëŸ¬ ì²˜ë¦¬** | ê°œë³„ì ìœ¼ë¡œ êµ¬í˜„ | í‘œì¤€í™”ëœ ì²˜ë¦¬ |
| **ì„±ëŠ¥** | ë§¤ë²ˆ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± | ì¬ì‚¬ìš©ê³¼ ìµœì í™” |
| **ìœ ì§€ë³´ìˆ˜** | ë¶„ì‚°ëœ ì„¤ì • ê´€ë¦¬ | ì¤‘ì•™í™”ëœ ê´€ë¦¬ |
| **í…ŒìŠ¤íŠ¸** | ê°ê° ë³„ë„ ì„¤ì • í•„ìš” | í†µí•©ëœ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ |

## ğŸ’¡ ê²°ë¡ 

Factory íŒ¨í„´ì€ Spring Kafkaì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ í•µì‹¬ ê°€ì¹˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤:

1. **ì¤‘ì•™í™”ëœ êµ¬ì„± ê´€ë¦¬**: ëª¨ë“  Kafka Consumer/Producer ì„¤ì •ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬
2. **íƒ€ì… ì•ˆì •ì„±**: ì»´íŒŒì¼ íƒ€ì„ì— íƒ€ì… ì²´í¬ë¡œ ëŸ°íƒ€ì„ ì—ëŸ¬ ë°©ì§€
3. **ì„±ëŠ¥ ìµœì í™”**: ë¦¬ì†ŒìŠ¤ ì¬ì‚¬ìš©ê³¼ ì»¤ë„¥ì…˜ í’€ë§ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ
4. **í‘œì¤€í™”ëœ ì—ëŸ¬ ì²˜ë¦¬**: ì¼ê´€ëœ ì—ëŸ¬ ì²˜ë¦¬ ì •ì±…ìœ¼ë¡œ ì•ˆì •ì„± ì¦ëŒ€
5. **ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ**: ì„¤ì • ë³€ê²½ ì‹œ í•œ ê³³ë§Œ ìˆ˜ì •í•˜ë©´ ì „ì²´ ì ìš©

Factory íŒ¨í„´ ì—†ì´ëŠ” ë¶„ì‚°ë˜ê³  ì¼ê´€ë˜ì§€ ì•Šì€ ì„¤ì •ìœ¼ë¡œ ì¸í•´ ì˜ˆì¸¡í•˜ê¸° ì–´ë ¤ìš´ ë¬¸ì œë“¤ì´ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì‹œìŠ¤í…œì˜ ì•ˆì •ì„±ê³¼ ì„±ëŠ¥ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ë¯¸ì¹©ë‹ˆë‹¤. ë”°ë¼ì„œ Spring Kafkaë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ë°˜ë“œì‹œ Factory íŒ¨í„´ì„ í™œìš©í•˜ì—¬ ì²´ê³„ì ì´ê³  í‘œì¤€í™”ëœ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•´ì•¼ í•©ë‹ˆë‹¤.