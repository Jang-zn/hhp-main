# 7. Kafka êµ¬ì¡° ê´€ë ¨ í•™ìŠµìë£Œ

## ğŸ“š ê°œìš”

Apache KafkaëŠ” LinkedInì—ì„œ ê°œë°œëœ ë¶„ì‚° ìŠ¤íŠ¸ë¦¬ë° í”Œë«í¼ìœ¼ë¡œ, ëŒ€ìš©ëŸ‰ ì‹¤ì‹œê°„ ë°ì´í„° íŒŒì´í”„ë¼ì¸ êµ¬ì¶•ì— í•µì‹¬ì ì¸ ì—­í• ì„ í•©ë‹ˆë‹¤. ì´ ë¬¸ì„œëŠ” Kafkaì˜ ë‚´ë¶€ êµ¬ì¡°ì™€ ì‘ë™ ì›ë¦¬ë¥¼ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ğŸ—ï¸ Kafka ì•„í‚¤í…ì²˜ êµ¬ì„± ìš”ì†Œ

### 1. **í•µì‹¬ ì»´í¬ë„ŒíŠ¸**

#### 1.1 Broker (ë¸Œë¡œì»¤)
```yaml
ì—­í• : ë©”ì‹œì§€ ì €ì¥ ë° ì „ë‹¬
íŠ¹ì§•:
  - Kafka í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•˜ëŠ” ì„œë²„
  - ê° ë¸Œë¡œì»¤ëŠ” ê³ ìœ í•œ IDë¥¼ ê°€ì§
  - í† í”½ì˜ íŒŒí‹°ì…˜ì„ ì €ì¥í•˜ê³  ê´€ë¦¬
  - ë¦¬ë”ì™€ íŒ”ë¡œì›Œ ì—­í•  ìˆ˜í–‰
```

#### 1.2 Topic (í† í”½)
```yaml
ì—­í• : ë©”ì‹œì§€ ì¹´í…Œê³ ë¦¬
íŠ¹ì§•:
  - ë…¼ë¦¬ì ì¸ ë©”ì‹œì§€ ê·¸ë£¹
  - ì—¬ëŸ¬ íŒŒí‹°ì…˜ìœ¼ë¡œ êµ¬ì„±
  - ì´ë¦„ìœ¼ë¡œ ì‹ë³„
  - ë¬´ì œí•œ ë©”ì‹œì§€ ì €ì¥ ê°€ëŠ¥
```

#### 1.3 Partition (íŒŒí‹°ì…˜)
```yaml
ì—­í• : í† í”½ì˜ ë¬¼ë¦¬ì  ë¶„í•  ë‹¨ìœ„
íŠ¹ì§•:
  - ìˆœì„œê°€ ë³´ì¥ë˜ëŠ” ë©”ì‹œì§€ ì‹œí€€ìŠ¤
  - ë³‘ë ¬ ì²˜ë¦¬ ë‹¨ìœ„
  - ê° íŒŒí‹°ì…˜ì€ ë¦¬ë”ì™€ íŒ”ë¡œì›Œ ë ˆí”Œë¦¬ì¹´ ë³´ìœ 
  - ì˜¤í”„ì…‹ìœ¼ë¡œ ë©”ì‹œì§€ ìœ„ì¹˜ ì¶”ì 
```

#### 1.4 Offset (ì˜¤í”„ì…‹)
```yaml
ì—­í• : ë©”ì‹œì§€ ìœ„ì¹˜ ì‹ë³„ì
íŠ¹ì§•:
  - íŒŒí‹°ì…˜ ë‚´ ë©”ì‹œì§€ì˜ ê³ ìœ  ID
  - ìˆœì°¨ì ìœ¼ë¡œ ì¦ê°€í•˜ëŠ” 64ë¹„íŠ¸ ì •ìˆ˜
  - Consumerê°€ ì½ì€ ìœ„ì¹˜ ì¶”ì 
  - ì¬ì²˜ë¦¬ ë° ì¥ì•  ë³µêµ¬ì— í™œìš©
```

---

## ğŸ”„ Kafka ë°ì´í„° íë¦„

### 1. **Producer â†’ Broker íë¦„**

```mermaid
graph LR
    P[Producer] -->|1. ë©”ì‹œì§€ ì „ì†¡| PB[ProducerBatch]
    PB -->|2. ë°°ì¹˜ ì „ì†¡| B1[Broker 1]
    B1 -->|3. ë³µì œ| B2[Broker 2]
    B1 -->|3. ë³µì œ| B3[Broker 3]
    B1 -->|4. ACK| P
```

**êµ¬í˜„ ì˜ˆì‹œ**:
```java
// KafkaEventAdapter.javaì—ì„œ ì‹¤ì œ êµ¬í˜„
@Override
public void publish(String topic, Object event) {
    String key = generatePartitionKey(event);
    
    ProducerRecord<String, Object> record = 
        new ProducerRecord<>(topic, key, event);
    
    kafkaProducer.send(record, (metadata, exception) -> {
        if (exception != null) {
            log.error("ì´ë²¤íŠ¸ ë°œí–‰ ì‹¤íŒ¨", exception);
        } else {
            log.info("ì´ë²¤íŠ¸ ë°œí–‰ ì„±ê³µ: partition={}, offset={}", 
                    metadata.partition(), metadata.offset());
        }
    });
}
```

### 2. **Broker â†’ Consumer íë¦„**

```mermaid
graph LR
    B[Broker] -->|1. ë©”ì‹œì§€ í˜ì¹˜| C1[Consumer 1]
    B -->|1. ë©”ì‹œì§€ í˜ì¹˜| C2[Consumer 2]
    C1 -->|2. ì˜¤í”„ì…‹ ì»¤ë°‹| B
    C2 -->|2. ì˜¤í”„ì…‹ ì»¤ë°‹| B
```

**êµ¬í˜„ ì˜ˆì‹œ**:
```java
// CouponRequestConsumer.javaì—ì„œ ì‹¤ì œ êµ¬í˜„
@KafkaListener(
    topics = "coupon-requests",
    containerFactory = "couponRequestKafkaListenerContainerFactory"
)
public void handleCouponRequest(
        CouponRequestEvent event,
        @Header(KafkaHeaders.RECEIVED_PARTITION) int partition,
        Acknowledgment ack) {
    
    // ë©”ì‹œì§€ ì²˜ë¦¬
    processCouponRequest(event);
    
    // ì˜¤í”„ì…‹ ì»¤ë°‹
    ack.acknowledge();
}
```

---

## ğŸ¯ Kafkaì˜ í•µì‹¬ ì„¤ê³„ ì›ì¹™

### 1. **ë¶„ì‚° ì²˜ë¦¬ (Distribution)**

```yaml
íŒŒí‹°ì…”ë‹:
  - í† í”½ì„ ì—¬ëŸ¬ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¶„í• 
  - íŒŒí‹°ì…˜ë³„ ë…ë¦½ì  ì²˜ë¦¬
  - ìˆ˜í‰ì  í™•ì¥ ê°€ëŠ¥

êµ¬í˜„ ì‚¬ë¡€:
  - userId ê¸°ë°˜ íŒŒí‹°ì…”ë‹ìœ¼ë¡œ ì‚¬ìš©ìë³„ ìˆœì„œ ë³´ì¥
  - 10ê°œ íŒŒí‹°ì…˜ìœ¼ë¡œ ì²˜ë¦¬ëŸ‰ 10ë°° í–¥ìƒ
```

### 2. **ë³µì œ (Replication)**

```yaml
ë¦¬ë”-íŒ”ë¡œì›Œ ëª¨ë¸:
  - ê° íŒŒí‹°ì…˜ì€ í•˜ë‚˜ì˜ ë¦¬ë”ì™€ Nê°œì˜ íŒ”ë¡œì›Œ
  - ë¦¬ë”ê°€ ëª¨ë“  ì½ê¸°/ì“°ê¸° ì²˜ë¦¬
  - íŒ”ë¡œì›ŒëŠ” ë¦¬ë” ë°ì´í„° ë³µì œ

ì¥ì•  ë³µêµ¬:
  - ë¦¬ë” ì‹¤íŒ¨ ì‹œ íŒ”ë¡œì›Œ ì¤‘ í•˜ë‚˜ê°€ ìƒˆ ë¦¬ë”
  - ISR(In-Sync Replicas) ê´€ë¦¬
  - min.insync.replicas ì„¤ì •ìœ¼ë¡œ ë°ì´í„° ì•ˆì •ì„± ë³´ì¥
```

### 3. **ë‚´êµ¬ì„± (Durability)**

```yaml
ë””ìŠ¤í¬ ì €ì¥:
  - ëª¨ë“  ë©”ì‹œì§€ëŠ” ë””ìŠ¤í¬ì— ìˆœì°¨ ê¸°ë¡
  - í˜ì´ì§€ ìºì‹œ í™œìš©ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
  - ì„¤ì • ê°€ëŠ¥í•œ ë³´ì¡´ ê¸°ê°„ (retention)

ACK ë©”ì»¤ë‹ˆì¦˜:
  - acks=0: ì „ì†¡ ì¦‰ì‹œ ì„±ê³µ
  - acks=1: ë¦¬ë” ì €ì¥ í›„ ì„±ê³µ
  - acks=all: ëª¨ë“  ISR ì €ì¥ í›„ ì„±ê³µ
```

---

## ğŸ”§ Kafka ë‚´ë¶€ ë™ì‘ ë©”ì»¤ë‹ˆì¦˜

### 1. **Controller ì„ ì¶œ ê³¼ì •**

```mermaid
sequenceDiagram
    participant B1 as Broker 1
    participant ZK as ZooKeeper/KRaft
    participant B2 as Broker 2
    participant B3 as Broker 3
    
    B1->>ZK: Controller ë“±ë¡ ì‹œë„
    B2->>ZK: Controller ë“±ë¡ ì‹œë„
    B3->>ZK: Controller ë“±ë¡ ì‹œë„
    ZK-->>B1: ë“±ë¡ ì„±ê³µ (Controller)
    ZK-->>B2: ë“±ë¡ ì‹¤íŒ¨ (Follower)
    ZK-->>B3: ë“±ë¡ ì‹¤íŒ¨ (Follower)
```

### 2. **ë©”ì‹œì§€ ì €ì¥ êµ¬ì¡°**

```
í† í”½: order-events
â”œâ”€â”€ partition-0/
â”‚   â”œâ”€â”€ 00000000000000000000.log    # ì‹¤ì œ ë©”ì‹œì§€ ë°ì´í„°
â”‚   â”œâ”€â”€ 00000000000000000000.index  # ì˜¤í”„ì…‹ ì¸ë±ìŠ¤
â”‚   â””â”€â”€ 00000000000000000000.timeindex  # íƒ€ì„ìŠ¤íƒ¬í”„ ì¸ë±ìŠ¤
â”œâ”€â”€ partition-1/
â”‚   â”œâ”€â”€ 00000000000000000000.log
â”‚   â”œâ”€â”€ 00000000000000000000.index
â”‚   â””â”€â”€ 00000000000000000000.timeindex
```

### 3. **Consumer Group ì¡°ì • í”„ë¡œí† ì½œ**

```yaml
Rebalancing ê³¼ì •:
  1. JoinGroup: ëª¨ë“  Consumerê°€ ì½”ë””ë„¤ì´í„°ì— ê°€ì… ìš”ì²­
  2. SyncGroup: íŒŒí‹°ì…˜ í• ë‹¹ ì •ë³´ ë™ê¸°í™”
  3. Heartbeat: ì£¼ê¸°ì ì¸ ìƒì¡´ ì‹ í˜¸ ì „ì†¡
  4. LeaveGroup: Consumer ì¢…ë£Œ ì‹œ ê·¸ë£¹ íƒˆí‡´

íŒŒí‹°ì…˜ í• ë‹¹ ì „ëµ:
  - RangeAssignor: í† í”½ë³„ ê· ë“± ë¶„ë°°
  - RoundRobinAssignor: ë¼ìš´ë“œë¡œë¹ˆ ë°©ì‹
  - StickyAssignor: ì¬í• ë‹¹ ìµœì†Œí™”
```

---

## ğŸ’¡ ì‹¤ì „ ì ìš©: í”„ë¡œì íŠ¸ êµ¬í˜„ ì‚¬ë¡€

### 1. **ì„ ì°©ìˆœ ì¿ í° ì‹œìŠ¤í…œ**

```java
// íŒŒí‹°ì…”ë‹ ì „ëµ
public String getPartitionKey() {
    // userId ê¸°ë°˜ìœ¼ë¡œ íŒŒí‹°ì…˜ ê²°ì •
    // ê°™ì€ ì‚¬ìš©ìì˜ ìš”ì²­ì€ ê°™ì€ íŒŒí‹°ì…˜ì—ì„œ ìˆœì°¨ ì²˜ë¦¬
    return "user:" + userId;
}

// íš¨ê³¼:
// - ì‚¬ìš©ìë³„ ìˆœì„œ ë³´ì¥
// - ì¤‘ë³µ ìš”ì²­ ë°©ì§€
// - 10,000+ TPS ì²˜ë¦¬
```

### 2. **ì‹¤ì‹œê°„ ìƒí’ˆ ë­í‚¹**

```java
@KafkaListener(topics = "order-completed")
public void updateProductRanking(OrderCompletedEvent event) {
    // ë¹„ë™ê¸° ë­í‚¹ ì—…ë°ì´íŠ¸
    event.getProducts().forEach(product -> {
        rankingService.incrementScore(
            product.getProductId(), 
            product.getQuantity()
        );
    });
}

// íš¨ê³¼:
// - ì‹¤ì‹œê°„ ë­í‚¹ ë°˜ì˜
// - ì£¼ë¬¸ íŠ¸ëœì­ì…˜ê³¼ ë¶„ë¦¬
// - í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°
```

### 3. **ì´ë²¤íŠ¸ ì†Œì‹± íŒ¨í„´**

```java
// EventLog ì €ì¥ + Kafka ë°œí–‰
@Transactional
public void publishEvent(String topic, Object event) {
    // 1. EventLog DB ì €ì¥
    EventLog log = EventLog.create(topic, event);
    eventLogRepository.save(log);
    
    // 2. Kafka ë°œí–‰
    kafkaProducer.send(new ProducerRecord<>(topic, event));
    
    // 3. ìƒíƒœ ì—…ë°ì´íŠ¸
    log.markPublished();
}

// íš¨ê³¼:
// - ì´ë²¤íŠ¸ ì¶”ì ì„±
// - ì¥ì•  ì‹œ ì¬ë°œí–‰ ê°€ëŠ¥
// - ê°ì‚¬(Audit) ë¡œê·¸
```

---

## ğŸ“Š ì„±ëŠ¥ ìµœì í™” íŒ

### 1. **Producer ìµœì í™”**

```yaml
ë°°ì¹˜ ì²˜ë¦¬:
  - batch.size: 16384 (16KB)
  - linger.ms: 10
  - compression.type: snappy

ë©”ëª¨ë¦¬ ê´€ë¦¬:
  - buffer.memory: 33554432 (32MB)
  - max.block.ms: 60000

ì‹ ë¢°ì„±:
  - acks: all
  - enable.idempotence: true
  - max.in.flight.requests.per.connection: 5
```

### 2. **Consumer ìµœì í™”**

```yaml
í˜ì¹˜ ìµœì í™”:
  - fetch.min.bytes: 1
  - fetch.max.wait.ms: 500
  - max.poll.records: 500

ì˜¤í”„ì…‹ ê´€ë¦¬:
  - enable.auto.commit: false
  - auto.offset.reset: earliest

ì„¸ì…˜ ê´€ë¦¬:
  - session.timeout.ms: 10000
  - heartbeat.interval.ms: 3000
```

### 3. **Broker ìµœì í™”**

```yaml
ë¡œê·¸ ì„¤ì •:
  - log.segment.bytes: 1073741824 (1GB)
  - log.retention.hours: 168
  - log.cleanup.policy: delete

ë³µì œ ì„¤ì •:
  - min.insync.replicas: 2
  - unclean.leader.election.enable: false
  - replica.lag.time.max.ms: 10000

ë„¤íŠ¸ì›Œí¬:
  - num.network.threads: 8
  - num.io.threads: 8
  - socket.send.buffer.bytes: 102400
```

---

## ğŸ†š Kafka vs ë‹¤ë¥¸ ë©”ì‹œì§• ì‹œìŠ¤í…œ

### **Kafka vs Redis Streams**

| íŠ¹ì„± | Kafka | Redis Streams |
|------|-------|---------------|
| **ì²˜ë¦¬ëŸ‰** | ë§¤ìš° ë†’ìŒ (100K+ msg/s) | ë†’ìŒ (10K+ msg/s) |
| **ë‚´êµ¬ì„±** | ë””ìŠ¤í¬ ê¸°ë°˜, ì˜êµ¬ ì €ì¥ | ë©”ëª¨ë¦¬ ê¸°ë°˜, ì„ íƒì  ì €ì¥ |
| **í™•ì¥ì„±** | ìˆ˜í‰ í™•ì¥ ìš©ì´ | ë‹¨ì¼ ë…¸ë“œ ì œì•½ |
| **ë³µì¡ë„** | ë†’ìŒ | ë‚®ìŒ |
| **ì‚¬ìš© ì‚¬ë¡€** | ëŒ€ìš©ëŸ‰ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë° | ì‹¤ì‹œê°„ ì•Œë¦¼, ê°„ë‹¨í•œ í |

### **Kafka vs RabbitMQ**

| íŠ¹ì„± | Kafka | RabbitMQ |
|------|-------|----------|
| **ë©”ì‹œì§• ëª¨ë¸** | Pull ê¸°ë°˜ | Push ê¸°ë°˜ |
| **ìˆœì„œ ë³´ì¥** | íŒŒí‹°ì…˜ ë‹¨ìœ„ | í ë‹¨ìœ„ |
| **ë©”ì‹œì§€ ë¼ìš°íŒ…** | í† í”½ ê¸°ë°˜ | Exchange ë¼ìš°íŒ… |
| **ì¬ì²˜ë¦¬** | ì˜¤í”„ì…‹ ê¸°ë°˜ ì¬ì²˜ë¦¬ ê°€ëŠ¥ | í•œ ë²ˆ ì†Œë¹„ í›„ ì‚­ì œ |
| **ëª¨ë‹ˆí„°ë§** | JMX, Kafka Manager | Management UI ì œê³µ |

---

## ğŸ“ í•™ìŠµ í•µì‹¬ í¬ì¸íŠ¸

### 1. **ì´í•´í•´ì•¼ í•  ê°œë…**
- [ ] íŒŒí‹°ì…˜ê³¼ ì˜¤í”„ì…‹ì˜ ê´€ê³„
- [ ] Consumer Groupì˜ ë¦¬ë°¸ëŸ°ì‹±
- [ ] ISRê³¼ ë³µì œ ë©”ì»¤ë‹ˆì¦˜
- [ ] íŠ¸ëœì­ì…˜ê³¼ Exactly-Once ì²˜ë¦¬

### 2. **ì‹¤ìŠµ ê¶Œì¥ ì‚¬í•­**
```bash
# Dockerë¡œ Kafka ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±
docker-compose up -d kafka zookeeper

# í† í”½ ìƒì„±
kafka-topics --create --topic test-topic \
  --bootstrap-server localhost:9092 \
  --partitions 3 --replication-factor 1

# ë©”ì‹œì§€ ë°œí–‰
kafka-console-producer --topic test-topic \
  --bootstrap-server localhost:9092

# ë©”ì‹œì§€ ì†Œë¹„
kafka-console-consumer --topic test-topic \
  --bootstrap-server localhost:9092 \
  --from-beginning
```

### 3. **í”„ë¡œë•ì…˜ ì²´í¬ë¦¬ìŠ¤íŠ¸**
- [ ] ëª¨ë‹ˆí„°ë§ ì„¤ì • (JMX, Prometheus)
- [ ] ì•ŒëŒ ì„¤ì • (ì§€ì—°, ì—ëŸ¬ìœ¨)
- [ ] ë°±ì—… ë° ë³µêµ¬ ê³„íš
- [ ] ìš©ëŸ‰ ê³„íš ë° í™•ì¥ ì „ëµ
- [ ] ë³´ì•ˆ ì„¤ì • (SSL/SASL)

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Apache Kafka ê³µì‹ ë¬¸ì„œ](https://kafka.apache.org/documentation/)
- [Confluent Platform ë¬¸ì„œ](https://docs.confluent.io/)
- [Kafka: The Definitive Guide](https://www.confluent.io/resources/kafka-the-definitive-guide/)
- [Kafka Streams in Action](https://www.manning.com/books/kafka-streams-in-action)
- [ì‹¤ì œ í”„ë¡œì íŠ¸ êµ¬í˜„ ì½”ë“œ](../src/main/java/kr/hhplus/be/server/adapter/event/)

---

**ì‘ì„±ì¼**: 2024-09-05  
**ì‘ì„±ì**: HH+ ì•„í‚¤í…ì²˜ íŒ€  
**ë²„ì „**: 1.0