<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ì»¤ë¨¸ìŠ¤ í”Œë«í¼ API íë¦„ë„</title>
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .header p {
            margin: 0;
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        .section h2 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
            padding-left: 20px;
        }
        
        .diagram {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }
        
        .api-info {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .tech-stack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .tech-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: transform 0.3s ease;
        }
        
        .tech-item:hover {
            transform: translateY(-5px);
            border-color: #3498db;
        }
        
        .tech-item h4 {
            color: #2c3e50;
            margin: 0 0 10px 0;
        }
        
        .footer {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        /* Mermaid ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• */
        .mermaid {
            background: white !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›’ ì´ì»¤ë¨¸ìŠ¤ í”Œë«í¼ API íë¦„ë„</h1>
            <p>Redis ê¸°ë°˜ ì‹¤ì‹œê°„ ë­í‚¹ & ì„ ì°©ìˆœ ì¿ í° ì‹œìŠ¤í…œ</p>
        </div>
        
        <div class="content">
            
            <!-- 1. ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ -->
            <div class="section">
                <h2>ğŸ—ï¸ ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜</h2>
                <div class="api-info">
                    <strong>ğŸ“‹ ì£¼ìš” íŠ¹ì§•:</strong> í´ë¦° ì•„í‚¤í…ì²˜, DIP ì›ì¹™, í¬íŠ¸-ì–´ëŒ‘í„° íŒ¨í„´, ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬
                </div>
                <div class="diagram">
                    <div class="mermaid">
graph TB
    subgraph "ğŸŒ API Layer"
        PC[ProductController<br/>ìƒí’ˆ ê´€ë¦¬]
        OC[OrderController<br/>ì£¼ë¬¸ ê´€ë¦¬] 
        BC[BalanceController<br/>ì”ì•¡ ê´€ë¦¬]
        CC[CouponController<br/>ì¿ í° ê´€ë¦¬]
    end
    
    subgraph "ğŸ—ï¸ Service Layer"
        PS[ProductService]
        OS[OrderService]
        BS[BalanceService]
        CS[CouponService]
    end
    
    subgraph "ğŸ’¼ UseCase Layer"
        PUC[Product UseCases]
        OUC[Order UseCases]
        BUC[Balance UseCases]
        CUC[Coupon UseCases]
    end
    
    subgraph "ğŸ”Œ Infrastructure"
        subgraph "ğŸ’¾ Storage"
            DB[(MySQL Database)]
        end
        subgraph "âš¡ Cache & Queue"
            REDIS[(Redis<br/>ìºì‹œ/ë­í‚¹/ì¿ í°)]
        end
        subgraph "ğŸ”’ External"
            LOCK[Distributed Lock]
        end
    end
    
    subgraph "ğŸ“¢ Event System"
        EP[Event Publisher]
        EH[Event Handlers<br/>- Ranking Update<br/>- Cache Invalidation]
    end
    
    PC --> PS --> PUC
    OC --> OS --> OUC
    BC --> BS --> BUC
    CC --> CS --> CUC
    
    PUC --> DB
    OUC --> DB
    BUC --> DB
    CUC --> DB
    
    PUC --> REDIS
    OUC --> REDIS
    BUC --> REDIS
    CUC --> REDIS
    
    BS --> LOCK
    OS --> EP --> EH --> REDIS
    
    classDef controller fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef service fill:#f3e5f5,stroke:#4a148c,stroke-width:2px  
    classDef usecase fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef storage fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef cache fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef event fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    
    class PC,OC,BC,CC controller
    class PS,OS,BS,CS service
    class PUC,OUC,BUC,CUC usecase
    class DB storage
    class REDIS,LOCK cache
    class EP,EH event
                    </div>
                </div>
            </div>
            
            <!-- 2. ìƒí’ˆ API íë¦„ -->
            <div class="section">
                <h2>ğŸ“¦ ìƒí’ˆ API íë¦„</h2>
                <div class="api-info">
                    <strong>ğŸ¯ í•µì‹¬ ê¸°ëŠ¥:</strong> Redis Sorted Set ê¸°ë°˜ ì‹¤ì‹œê°„ ë­í‚¹, Cache-Aside íŒ¨í„´, DB í´ë°± ì „ëµ
                </div>
                <div class="diagram">
                    <div class="mermaid">
sequenceDiagram
    participant Client
    participant Controller
    participant Service
    participant UseCase
    participant Cache
    participant DB

    Note over Client,DB: ğŸ“¦ GET /api/product/list - ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
    Client->>Controller: GET /api/product/list
    Controller->>Service: ìƒí’ˆëª©ë¡ì¡°íšŒ()
    Service->>UseCase: ìƒí’ˆëª©ë¡ì¡°íšŒìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>Cache: ìƒí’ˆ ëª©ë¡ ìºì‹œ í™•ì¸
    alt ìºì‹œ íˆíŠ¸
        Cache-->>UseCase: ìºì‹œëœ ëª©ë¡ ë°˜í™˜
    else ìºì‹œ ë¯¸ìŠ¤
        UseCase->>DB: ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
        DB-->>UseCase: ìƒí’ˆ ëª©ë¡ ë°ì´í„°
        UseCase->>Cache: ìºì‹œì— ì €ì¥
    end
    UseCase-->>Service: ìƒí’ˆ ëª©ë¡
    Service-->>Controller: ìƒí’ˆ ëª©ë¡
    Controller-->>Client: 200 OK + ìƒí’ˆ ëª©ë¡

    Note over Client,DB: ğŸ† GET /api/product/popular - ì¸ê¸° ìƒí’ˆ ì¡°íšŒ
    Client->>Controller: GET /api/product/popular
    Controller->>Service: ì¸ê¸°ìƒí’ˆì¡°íšŒ()
    Service->>UseCase: ì¸ê¸°ìƒí’ˆëª©ë¡ì¡°íšŒìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>Cache: Redis ZRANGE ë­í‚¹ ì¡°íšŒ
    alt Redis ì„±ê³µ
        Cache-->>UseCase: ë­í‚¹ ìƒí’ˆ ID ëª©ë¡
        UseCase->>Cache: ìƒí’ˆ ìƒì„¸ì •ë³´ ì¡°íšŒ
        Cache-->>UseCase: ìƒí’ˆ ìƒì„¸ì •ë³´
    else Redis ì‹¤íŒ¨
        UseCase->>DB: DB í´ë°± ì¡°íšŒ
        DB-->>UseCase: ìƒí’ˆ ë°ì´í„°
        UseCase->>Cache: ìºì‹œì— ì €ì¥
    end
    UseCase-->>Service: ë­í‚¹ ìƒí’ˆ ëª©ë¡
    Service-->>Controller: ì¸ê¸° ìƒí’ˆ ëª©ë¡
    Controller-->>Client: 200 OK + ì¸ê¸° ìƒí’ˆ ëª©ë¡

    Note over Client,DB: ğŸ” GET /api/product/{id} - ìƒí’ˆ ìƒì„¸ ì¡°íšŒ
    Client->>Controller: GET /api/product/{id}
    Controller->>Service: ìƒí’ˆì¡°íšŒ(id)
    Service->>UseCase: ìƒí’ˆì¡°íšŒìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>Cache: ìƒí’ˆ ìºì‹œ í™•ì¸
    alt ìºì‹œ íˆíŠ¸
        Cache-->>UseCase: ìºì‹œëœ ìƒí’ˆ
    else ìºì‹œ ë¯¸ìŠ¤
        UseCase->>DB: IDë¡œ ìƒí’ˆ ì¡°íšŒ
        DB-->>UseCase: ìƒí’ˆ ë°ì´í„°
        UseCase->>Cache: ìƒí’ˆ ì €ì¥
    end
    UseCase-->>Service: ìƒí’ˆ ì •ë³´
    Service-->>Controller: ìƒí’ˆ ìƒì„¸ì •ë³´
    Controller-->>Client: 200 OK + ìƒí’ˆ ìƒì„¸ì •ë³´

    Note over Client,DB: â• POST /api/product - ìƒí’ˆ ìƒì„±
    Client->>Controller: POST /api/product
    Controller->>Service: ìƒí’ˆìƒì„±(ìš”ì²­)
    Service->>UseCase: ìƒí’ˆìƒì„±ìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>DB: ìƒí’ˆ ê²€ì¦ ë° ìƒì„±
    UseCase->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹
    UseCase->>Cache: ê´€ë ¨ ìºì‹œ ë¬´íš¨í™”
    UseCase-->>Service: ìƒì„±ëœ ìƒí’ˆ
    Service-->>Controller: ìƒí’ˆ ìƒì„± ì™„ë£Œ
    Controller-->>Client: 201 Created + ìƒí’ˆ ì •ë³´

    Note over Client,DB: âœï¸ PUT /api/product/{id} - ìƒí’ˆ ìˆ˜ì •
    Client->>Controller: PUT /api/product/{id}
    Controller->>Service: ìƒí’ˆìˆ˜ì •(id, ìš”ì²­)
    Service->>UseCase: ìƒí’ˆìˆ˜ì •ìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>DB: ìƒí’ˆ ê²€ì¦ ë° ìˆ˜ì •
    UseCase->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹
    UseCase->>Cache: ìƒí’ˆ ìºì‹œ ë¬´íš¨í™”
    UseCase-->>Service: ìˆ˜ì •ëœ ìƒí’ˆ
    Service-->>Controller: ìƒí’ˆ ìˆ˜ì • ì™„ë£Œ
    Controller-->>Client: 200 OK + ìƒí’ˆ ì •ë³´

    Note over Client,DB: ğŸ—‘ï¸ DELETE /api/product/{id} - ìƒí’ˆ ì‚­ì œ
    Client->>Controller: DELETE /api/product/{id}
    Controller->>Service: ìƒí’ˆì‚­ì œ(id)
    Service->>UseCase: ìƒí’ˆì‚­ì œìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>DB: ìƒí’ˆ ê²€ì¦ ë° ì‚­ì œ
    UseCase->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹
    UseCase->>Cache: ëª¨ë“  ìƒí’ˆ ìºì‹œ ë¬´íš¨í™”
    UseCase-->>Service: ì‚­ì œ ì„±ê³µ
    Service-->>Controller: ì‚­ì œ í™•ì¸
    Controller-->>Client: 204 No Content
                    </div>
                </div>
            </div>
            
            <!-- 3. ì£¼ë¬¸ & ê²°ì œ API íë¦„ -->
            <div class="section">
                <h2>ğŸ›’ ì£¼ë¬¸ & ê²°ì œ API íë¦„</h2>
                <div class="api-info">
                    <strong>âš¡ í•µì‹¬ ê¸°ëŠ¥:</strong> ë¶„ì‚° ë½ ê¸°ë°˜ ë™ì‹œì„± ì œì–´, ì´ë²¤íŠ¸ ê¸°ë°˜ ë­í‚¹ ì—…ë°ì´íŠ¸, íŠ¸ëœì­ì…˜ ê´€ë¦¬
                </div>
                <div class="diagram">
                    <div class="mermaid">
sequenceDiagram
    participant Client
    participant Controller
    participant Service
    participant UseCase
    participant Lock as Redis Lock
    participant DB
    participant EventBus
    participant RankingHandler

    Note over Client,RankingHandler: ğŸ›’ POST /api/order - ì£¼ë¬¸ ìƒì„±
    Client->>Controller: POST /api/order
    Controller->>Service: ì£¼ë¬¸ìƒì„±(ì£¼ë¬¸ìš”ì²­)
    Service->>UseCase: ì£¼ë¬¸ìƒì„±ìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>DB: ì¬ê³  í™•ì¸ ë° ì˜ˆì•½
    UseCase->>DB: ì£¼ë¬¸ ì—”í‹°í‹° ìƒì„±
    UseCase->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹
    UseCase-->>Service: ì£¼ë¬¸ ìƒì„± ì™„ë£Œ
    Service-->>Controller: ì£¼ë¬¸ ì‘ë‹µ
    Controller-->>Client: 201 Created + ì£¼ë¬¸ ì •ë³´

    Note over Client,RankingHandler: ğŸ’³ POST /api/order/{orderId}/pay - ì£¼ë¬¸ ê²°ì œ
    Client->>Controller: POST /api/order/{id}/pay
    Controller->>Service: ì£¼ë¬¸ê²°ì œ(ì£¼ë¬¸ID, ì‚¬ìš©ìID)
    Service->>UseCase: ì£¼ë¬¸ê²°ì œìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>Lock: ë¶„ì‚° ë½ íšë“
    alt ë½ íšë“ ì„±ê³µ
        UseCase->>DB: ì”ì•¡ ì°¨ê° ë° ê²°ì œ
        UseCase->>DB: ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        UseCase->>EventBus: ì£¼ë¬¸ì™„ë£Œì´ë²¤íŠ¸ ë°œí–‰
        UseCase->>Lock: ë½ í•´ì œ
        EventBus->>RankingHandler: ë¹„ë™ê¸° ë­í‚¹ ì—…ë°ì´íŠ¸
        RankingHandler->>Lock: Redis ZADD ìƒí’ˆë³„ ì£¼ë¬¸ëŸ‰
    else ë½ íšë“ ì‹¤íŒ¨
        UseCase-->>Service: ë™ì‹œì„± ì¶©ëŒ
        Service-->>Controller: 409 ì¶©ëŒ
        Controller-->>Client: 409 ì¶©ëŒ
    end
    UseCase-->>Service: ê²°ì œ ì„±ê³µ
    Service-->>Controller: ê²°ì œ ì‘ë‹µ
    Controller-->>Client: 200 OK + ê²°ì œ ê²°ê³¼

    Note over Client,RankingHandler: ğŸ“‹ GET /api/order/{orderId} - ì£¼ë¬¸ ì¡°íšŒ
    Client->>Controller: GET /api/order/{id}
    Controller->>Service: ì£¼ë¬¸ì¡°íšŒ(ì£¼ë¬¸ID)
    Service->>UseCase: ì£¼ë¬¸ì¡°íšŒìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>DB: IDë¡œ ì£¼ë¬¸ ì¡°íšŒ
    UseCase-->>Service: ì£¼ë¬¸ ìƒì„¸ì •ë³´
    Service-->>Controller: ì£¼ë¬¸ ì •ë³´
    Controller-->>Client: 200 OK + ì£¼ë¬¸ ì •ë³´

    Note over Client,RankingHandler: ğŸ“œ GET /api/order/user/{userId} - ì‚¬ìš©ì ì£¼ë¬¸ ëª©ë¡
    Client->>Controller: GET /api/order/user/{userId}
    Controller->>Service: ì£¼ë¬¸ëª©ë¡ì¡°íšŒ(ì‚¬ìš©ìID)
    Service->>UseCase: ì£¼ë¬¸ëª©ë¡ì¡°íšŒìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>DB: í˜ì´ì§• ì¡°íšŒ
    UseCase-->>Service: ì£¼ë¬¸ ëª©ë¡
    Service-->>Controller: ì‚¬ìš©ì ì£¼ë¬¸ ëª©ë¡
    Controller-->>Client: 200 OK + ì£¼ë¬¸ ëª©ë¡
                    </div>
                </div>
            </div>
            
            <!-- 4. ì¿ í° API íë¦„ -->
            <div class="section">
                <h2>ğŸ« ì¿ í° API íë¦„ (ì„ ì°©ìˆœ ì‹œìŠ¤í…œ)</h2>
                <div class="api-info">
                    <strong>ğŸš€ í•µì‹¬ ê¸°ëŠ¥:</strong> Redis Atomic ì—°ì‚° ê¸°ë°˜ ì„ ì°©ìˆœ ì²˜ë¦¬, Race Condition ì™„ë²½ í•´ê²°, ì¤‘ë³µ ë°œê¸‰ ë°©ì§€
                </div>
                <div class="diagram">
                    <div class="mermaid">
sequenceDiagram
    participant Client
    participant Controller
    participant Service
    participant UseCase
    participant Cache
    participant Counter as Redis Counter
    participant DB
    participant Scheduler

    Note over Client,Scheduler: ğŸ« POST /api/coupon/issue - ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰
    Client->>Controller: POST /api/coupon/issue
    Controller->>Service: ì¿ í°ë°œê¸‰(ì¿ í°ID, ì‚¬ìš©ìID)
    Service->>UseCase: ì¿ í°ë°œê¸‰ìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>DB: ì¿ í° ë°œê¸‰ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    alt ì¿ í° ë°œê¸‰ ê°€ëŠ¥
        UseCase->>Counter: ì›ìì  ë°œê¸‰ ì—°ì‚°
        Counter->>Counter: ì¤‘ë³µ ì‚¬ìš©ì í™•ì¸
        Counter->>Counter: ì¦ê°€ ë° í•œë„ ê²€ì¦
        alt ë°œê¸‰ ì„±ê³µ
            Counter-->>UseCase: ë°œê¸‰ëœ ì¹´ìš´íŠ¸
            UseCase->>DB: ì¿ í° ì´ë ¥ ì €ì¥
            UseCase->>Cache: ìºì‹œ ë¬´íš¨í™”
        else ë°œê¸‰ ì‹¤íŒ¨
            Counter-->>UseCase: -1 (ì‹¤íŒ¨)
            UseCase-->>Service: ì´ë¯¸ë°œê¸‰ë¨/í•œë„ì´ˆê³¼
        end
    else ì¿ í° ë°œê¸‰ ë¶ˆê°€
        UseCase-->>Service: ì¿ í°ë°œê¸‰ë¶ˆê°€
    end
    UseCase-->>Service: ë°œê¸‰ ê²°ê³¼
    Service-->>Controller: ì¿ í° ë°œê¸‰ ì™„ë£Œ
    Controller-->>Client: 200 OK + ì¿ í° ì •ë³´

    Note over Client,Scheduler: ğŸ“‹ GET /api/coupon/user/{userId} - ì‚¬ìš©ì ì¿ í° ëª©ë¡
    Client->>Controller: GET /api/coupon/user/{userId}
    Controller->>Service: ì¿ í°ëª©ë¡ì¡°íšŒ(ì‚¬ìš©ìID)
    Service->>UseCase: ì¿ í°ëª©ë¡ì¡°íšŒìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>Cache: ì¿ í° ëª©ë¡ ìºì‹œ í™•ì¸
    alt ìºì‹œ íˆíŠ¸
        Cache-->>UseCase: ìºì‹œëœ ì¿ í° ëª©ë¡
    else ìºì‹œ ë¯¸ìŠ¤
        UseCase->>DB: ì‚¬ìš©ì ì¿ í° ì¡°íšŒ
        DB-->>UseCase: ì¿ í° ëª©ë¡
        UseCase->>Cache: ìºì‹œì— ì €ì¥
    end
    UseCase-->>Service: ì‚¬ìš©ì ì¿ í° ëª©ë¡
    Service-->>Controller: ì¿ í° ëª©ë¡
    Controller-->>Client: 200 OK + ì¿ í° ëª©ë¡

    Note over Client,Scheduler: â° ìŠ¤ì¼€ì¤„ë§ ì¿ í° ë§Œë£Œ ì²˜ë¦¬
    loop ë§¤ì‹œ ì‹¤í–‰
        Scheduler->>UseCase: ì¿ í°ë§Œë£Œì²˜ë¦¬ìœ ìŠ¤ì¼€ì´ìŠ¤
        UseCase->>DB: ë§Œë£Œëœ ì¿ í° ìƒíƒœ ì—…ë°ì´íŠ¸
        UseCase->>Cache: ë§Œë£Œëœ ìºì‹œ ë¬´íš¨í™”
    end
                    </div>
                </div>
            </div>
            
            <!-- 5. ì”ì•¡ API íë¦„ -->
            <div class="section">
                <h2>ğŸ’° ì”ì•¡ API íë¦„</h2>
                <div class="api-info">
                    <strong>ğŸ” í•µì‹¬ ê¸°ëŠ¥:</strong> ë¶„ì‚° ë½ìœ¼ë¡œ ë™ì‹œì„± ì œì–´, íŠ¸ëœì­ì…˜ ì•ˆì •ì„± ë³´ì¥, ì”ì•¡ ì¶©ì „ ë° ì¡°íšŒ
                </div>
                <div class="diagram">
                    <div class="mermaid">
sequenceDiagram
    participant Client
    participant Controller
    participant Service
    participant UseCase
    participant Lock as Redis Lock
    participant DB

    Note over Client,DB: ğŸ’³ POST /api/balance/charge - ì”ì•¡ ì¶©ì „
    Client->>Controller: POST /api/balance/charge
    Controller->>Service: ì”ì•¡ì¶©ì „(ì‚¬ìš©ìID, ê¸ˆì•¡)
    Service->>UseCase: ì”ì•¡ì¶©ì „ìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>Lock: ë¶„ì‚° ë½ íšë“
    alt ë½ íšë“ ì„±ê³µ
        UseCase->>DB: ì”ì•¡ ì¡°íšŒ ë˜ëŠ” ìƒì„±
        UseCase->>DB: ì¶©ì „ ê¸ˆì•¡ ê²€ì¦
        alt ìœ íš¨í•œ ê¸ˆì•¡
            UseCase->>DB: ì”ì•¡ ì—…ë°ì´íŠ¸ (+)
            UseCase->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹
            UseCase->>Lock: ë½ í•´ì œ
            UseCase-->>Service: ì¶©ì „ ì„±ê³µ
        else ìœ íš¨í•˜ì§€ ì•Šì€ ê¸ˆì•¡
            UseCase->>Lock: ë½ í•´ì œ
            UseCase-->>Service: ìœ íš¨í•˜ì§€ì•Šì€ê¸ˆì•¡
        end
    else ë½ íšë“ ì‹¤íŒ¨
        UseCase-->>Service: ë™ì‹œì„± ì¶©ëŒ
    end
    Service-->>Controller: ì¶©ì „ ê²°ê³¼
    Controller-->>Client: 200 OK + ì”ì•¡ ì •ë³´

    Note over Client,DB: ğŸ’° GET /api/balance/{userId} - ì”ì•¡ ì¡°íšŒ
    Client->>Controller: GET /api/balance/{userId}
    Controller->>Service: ì”ì•¡ì¡°íšŒ(ì‚¬ìš©ìID)
    Service->>UseCase: ì”ì•¡ì¡°íšŒìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>DB: ì‚¬ìš©ì ì”ì•¡ ì¡°íšŒ
    alt ì”ì•¡ ì¡´ì¬
        DB-->>UseCase: í˜„ì¬ ì”ì•¡
    else ì”ì•¡ ì—†ìŒ
        DB-->>UseCase: ê¸°ë³¸ê°’ 0
    end
    UseCase-->>Service: ì”ì•¡ ì •ë³´
    Service-->>Controller: ì”ì•¡ ì •ë³´
    Controller-->>Client: 200 OK + ì”ì•¡ ì •ë³´

    Note over Client,DB: ğŸ’¸ POST /api/balance/deduct - ì”ì•¡ ì°¨ê°
    Client->>Controller: POST /api/balance/deduct
    Controller->>Service: ì”ì•¡ì°¨ê°(ì‚¬ìš©ìID, ê¸ˆì•¡)
    Service->>UseCase: ì”ì•¡ì°¨ê°ìœ ìŠ¤ì¼€ì´ìŠ¤
    UseCase->>Lock: ë¶„ì‚° ë½ íšë“
    alt ë½ íšë“ ì„±ê³µ
        UseCase->>DB: í˜„ì¬ ì”ì•¡ ì¡°íšŒ
        alt ì”ì•¡ ì¶©ë¶„
            UseCase->>DB: ì”ì•¡ ì—…ë°ì´íŠ¸ (-)
            UseCase->>DB: íŠ¸ëœì­ì…˜ ì»¤ë°‹
            UseCase->>Lock: ë½ í•´ì œ
            UseCase-->>Service: ì°¨ê° ì„±ê³µ
        else ì”ì•¡ ë¶€ì¡±
            UseCase->>Lock: ë½ í•´ì œ
            UseCase-->>Service: ì”ì•¡ë¶€ì¡±
        end
    else ë½ íšë“ ì‹¤íŒ¨
        UseCase-->>Service: ë™ì‹œì„± ì¶©ëŒ
    end
    Service-->>Controller: ì°¨ê° ê²°ê³¼
    Controller-->>Client: 200 OK + ì”ì•¡ ì •ë³´
                    </div>
                </div>
            </div>
            
            <!-- 6. Redis í™œìš© ì „ëµ -->
            <div class="section">
                <h2>âš¡ Redis í™œìš© ì „ëµ</h2>
                <div class="tech-stack">
                    <div class="tech-item">
                        <h4>ğŸ† Sorted Set</h4>
                        <p>ì‹¤ì‹œê°„ ìƒí’ˆ ë­í‚¹<br/>O(log N) ì„±ëŠ¥<br/>ZADD/ZRANGE</p>
                    </div>
                    <div class="tech-item">
                        <h4>âš›ï¸ Atomic Long</h4>
                        <p>ì„ ì°©ìˆœ ì¿ í° ì¹´ìš´í„°<br/>Race Condition í•´ê²°<br/>INCREMENT/DECREMENT</p>
                    </div>
                    <div class="tech-item">
                        <h4>ğŸ’¾ Bucket</h4>
                        <p>ê°œë³„ ë°ì´í„° ìºì‹±<br/>TTL ê¸°ë°˜ ë§Œë£Œ<br/>GET/SET/EXPIRE</p>
                    </div>
                    <div class="tech-item">
                        <h4>ğŸ”’ Distributed Lock</h4>
                        <p>ë¶„ì‚° í™˜ê²½ ë™ì‹œì„±<br/>Redisson í™œìš©<br/>LOCK/UNLOCK</p>
                    </div>
                </div>
            </div>
            
            <!-- 7. ì„±ëŠ¥ ìµœì í™” ìš”ì†Œ -->
            <div class="section">
                <h2>ğŸš€ ì„±ëŠ¥ ìµœì í™” ìš”ì†Œ</h2>
                <div class="diagram">
                    <div class="mermaid">
graph TD
    A[ì„±ëŠ¥ ìµœì í™”] --> B[Cache ì „ëµ]
    A --> C[ë™ì‹œì„± ì œì–´]
    A --> D[ì‹¤ì‹œê°„ ì²˜ë¦¬]
    A --> E[DB ìµœì í™”]
    A --> F[í´ë°± ì „ëµ]
    
    B --> B1[Cache-Aside íŒ¨í„´]
    B --> B2[TTL ê¸°ë°˜ ë§Œë£Œ]
    B --> B3[Cache Stampede ë°©ì–´]
    
    C --> C1[Redis ë¶„ì‚° ë½]
    C --> C2[Atomic ì—°ì‚°]
    C --> C3[ë°ë“œë½ ë°©ì§€]
    
    D --> D1[Event-Driven Architecture]
    D --> D2[ë¹„ë™ê¸° í•¸ë“¤ëŸ¬]
    D --> D3[ì¥ì•  ê²©ë¦¬]
    
    E --> E1[Connection Pooling]
    E --> E2[íŠ¸ëœì­ì…˜ ê²©ë¦¬]
    E --> E3[ì¸ë±ìŠ¤ ìµœì í™”]
    
    F --> F1[Redis ì¥ì•  ëŒ€ì‘]
    F --> F2[DB í´ë°±]
    F --> F3[Circuit Breaker]
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="footer">
            <p>ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ: Spring Boot 3.x, Redis (Redisson), MySQL, JPA, Event-Driven Architecture</p>
            <p>ğŸ“… ìƒì„±ì¼: 2025-08-21 | ğŸ“Š í”„ë¡œì íŠ¸: ì´ì»¤ë¨¸ìŠ¤ í”Œë«í¼ Redis ì‹œìŠ¤í…œ ë””ìì¸</p>
        </div>
    </div>

    <script>
        // Mermaid 10.x ì´ˆê¸°í™” ë°©ì‹
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.initialize({ 
                startOnLoad: true,
                theme: 'default',
                securityLevel: 'loose',
                flowchart: {
                    htmlLabels: true,
                    curve: 'basis'
                },
                themeVariables: {
                    primaryColor: '#3498db',
                    primaryTextColor: '#2c3e50',
                    primaryBorderColor: '#3498db',
                    lineColor: '#34495e'
                }
            });
        });
    </script>
</body>
</html>